<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>登链-第二课 | Q1ngying</title><meta name="author" content="Q1ngying"><meta name="copyright" content="Q1ngying"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="constructor()构造函数的 bytecode 是不会部署到区块链上的，因为constructor()的逻辑只在部署合约时调用，所以不用部署到区块链上，而在部署一个合约时，传入deployBytecode的时候是需要传递constructor()中函数逻辑的bytecode的。 合约地址预测python 脚本实现： import rlp from eth_utils import kecc">
<meta property="og:type" content="article">
<meta property="og:title" content="登链-第二课">
<meta property="og:url" content="https://q1ngying.cn/2023/11/06/%E7%99%BB%E9%93%BE-%E7%AC%AC%E4%BA%8C%E8%AF%BE/index.html">
<meta property="og:site_name" content="Q1ngying">
<meta property="og:description" content="constructor()构造函数的 bytecode 是不会部署到区块链上的，因为constructor()的逻辑只在部署合约时调用，所以不用部署到区块链上，而在部署一个合约时，传入deployBytecode的时候是需要传递constructor()中函数逻辑的bytecode的。 合约地址预测python 脚本实现： import rlp from eth_utils import kecc">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://q1ngying.cn/img/butterfly-icon.jpg">
<meta property="article:published_time" content="2023-11-06T11:38:49.000Z">
<meta property="article:modified_time" content="2023-11-06T11:39:22.618Z">
<meta property="article:author" content="Q1ngying">
<meta property="article:tag" content="Security">
<meta property="article:tag" content="Solidity">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://q1ngying.cn/img/butterfly-icon.jpg"><link rel="shortcut icon" href="/img/icons8-clover-ios-16-glyph-32.png"><link rel="canonical" href="https://q1ngying.cn/2023/11/06/%E7%99%BB%E9%93%BE-%E7%AC%AC%E4%BA%8C%E8%AF%BE/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><meta name="google-site-verification" content="IzCM4B791_p7IAU4WhRfiLlPBnODnamJ7ixKxzoeNfk"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '登链-第二课',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-11-06 19:39:22'
}</script><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/butterfly-icon.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">76</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">29</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">29</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/back1.webp);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Q1ngying</span></a><a class="nav-page-title" href="/"><span class="site-name">登链-第二课</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">登链-第二课</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-11-06T11:38:49.000Z" title="发表于 2023-11-06 19:38:49">2023-11-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-11-06T11:39:22.618Z" title="更新于 2023-11-06 19:39:22">2023-11-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Security/">Security</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Solidity/">Solidity</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">15k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>51 mins.分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p><code>constructor()</code>构造函数的 bytecode 是不会部署到区块链上的，因为<code>constructor()</code>的逻辑只在部署合约时调用，所以不用部署到区块链上，而在部署一个合约时，传入<code>deployBytecode</code>的时候是需要传递<code>constructor()</code>中函数逻辑的bytecode的。</p>
<h2 id="合约地址预测"><a href="#合约地址预测" class="headerlink" title="合约地址预测"></a>合约地址预测</h2><p>python 脚本实现：</p>
<pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> rlp <span class="token keyword">from</span> eth_utils
<span class="token keyword">import</span> keccak<span class="token punctuation">,</span> to_checksum_address<span class="token punctuation">,</span> to_bytes
<span class="token keyword">def</span> <span class="token function">mk_contract_address</span><span class="token punctuation">(</span>sender<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> nonce<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token builtin">str</span> <span class="token punctuation">:</span>
    sender_bytes <span class="token operator">=</span> to_bytes<span class="token punctuation">(</span>hexstr<span class="token operator">=</span>sender<span class="token punctuation">)</span>
    raw <span class="token operator">=</span> rip<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">[</span>sender_bytes<span class="token punctuation">,</span> nonce<span class="token punctuation">]</span><span class="token punctuation">)</span>
    h <span class="token operator">=</span> keccak<span class="token punctuation">(</span>raw<span class="token punctuation">)</span>
    address_bytes <span class="token operator">=</span> h<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> to_checksum_address<span class="token punctuation">(</span>address_bytes<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="CREATE-联合-CREATE2-攻击"><a href="#CREATE-联合-CREATE2-攻击" class="headerlink" title="CREATE 联合 CREATE2 攻击"></a>CREATE 联合 CREATE2 攻击</h2><h3 id="关于合约自销毁的小知识："><a href="#关于合约自销毁的小知识：" class="headerlink" title="关于合约自销毁的小知识："></a>关于合约自销毁的小知识：</h3><p>部署合约时，如果计算出的地址存在 code 那么将会部署失败。</p>
<p>合约销毁时（<code>selfdestruct()</code>），该地址对应的code，storage 也会跟着销毁。</p>
<h3 id="CREATE-创建合约："><a href="#CREATE-创建合约：" class="headerlink" title="CREATE 创建合约："></a>CREATE 创建合约：</h3><p>CREATE 操作码创建出来的<strong>合约地址</strong>只与两个值有关：<strong><code>sender</code>和<code>nonce</code></strong></p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity">new_address <span class="token operator">=</span> <span class="token function">keccak256</span><span class="token punctuation">(</span>sender<span class="token punctuation">,</span> nonce<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li>sender：部署这个合约的地址</li>
<li><code>nonce</code>：当前账号发起的交易数量</li>
</ul>
<p><strong>nonce 的值随着每一笔交易的发起不断增加，就算合约销毁后，使用 CREATE 操作创建合约，也不能在原地址部署新的合约</strong></p>
<h3 id="CREATE2-创建合约"><a href="#CREATE2-创建合约" class="headerlink" title="CREATE2 创建合约"></a>CREATE2 创建合约</h3><p>CREATE2 操作码创建出来的<strong>合约地址</strong>与这三个值有关：<code>sender</code>、<code>bytescode</code>和<code>salt</code> <strong>与 nonce 无关</strong></p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity">new_address <span class="token operator">=</span> <span class="token function">keccak256</span><span class="token punctuation">(</span><span class="token number">0xff</span><span class="token punctuation">,</span> sender<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> bytescode<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><code>sender</code>：部署这个合约的地址</li>
<li><code>bytescode</code>：要部署的合约的字节码</li>
<li><code>salt</code>：盐值</li>
</ul>
<p><strong>CREATE2 的用处就是确保：在要部署的合约 bytescode 不变，salt 不变的情况下，生成的合约地址不变</strong></p>
<h3 id="CREATE-和-CREATE2-联合使用攻击"><a href="#CREATE-和-CREATE2-联合使用攻击" class="headerlink" title="CREATE 和 CREATE2 联合使用攻击"></a>CREATE 和 CREATE2 联合使用攻击</h3><p>该攻击的目的：<strong>在不改变合约地址的情况下，来修改合约的代码</strong></p>
<p>create 出的地址是由 sender 和 nonce 决定</p>
<p>而 create2 出的地址是由 bytecode，sender，bytecode 决定，这就出现了漏洞：</p>
<p><strong>我使用合约 A CREATE2 出来一个 B1 合约，B1 合约使用 Create 出来一个 C1 合约，这个时候销毁 B 合约和 C 合约，在重新部署一个 B2 合约（B2 合约和B1 合约完全一致，salt 和 bytescode不变，新生成的 B2 合约地址和第一次合约 B1 地址相同），这时我使用 B2 再创建 C2 合约（此时 C2 合约可以与 C1 合约不同，因为 C2 合约是由 B2 合约使用 CREATE 创建出来，CREATE只和B2 的地址和 nonce 有关，B2 合约地址由于 B2 合约代码没有发生改变，盐值不变，所以 B2 地址和 B1 地址相同，nonce 因为 B2 重新部署发生重置，所以新生成的 C2 合约尽管和 C1 合约代码不同，但是地址是相同的）</strong></p>
<p><img src="../images/登链-第二课/eea2c8e1708acba786658af3957e8aa.png" alt="eea2c8e1708acba786658af3957e8aa"></p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// contract A</span>
<span class="token keyword">contract</span> <span class="token class-name">ContractFactoryContract</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">event</span> <span class="token function">CreatorFactoryDeploy</span><span class="token punctuation">(</span><span class="token builtin">address</span> addrodc<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token builtin">address</span> <span class="token keyword">public</span> _createContractaddr<span class="token punctuation">;</span>
	
	<span class="token keyword">function</span> <span class="token function">deployCreator</span><span class="token punctuation">(</span><span class="token builtin">uint</span> _salt<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token punctuation">&#123;</span>
		CreatorContract _creatorContract <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CreatorContract</span><span class="token punctuation">&#123;</span>salt<span class="token punctuation">:</span> <span class="token builtin">bytes32</span><span class="token punctuation">(</span>_salt<span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">emit</span> <span class="token function">CreatorFactoryDeploy</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span>_creatorcontract<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		_createContractaddr <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span>_creatorcontract<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// contract B</span>
<span class="token keyword">contract</span> <span class="token class-name">FactoryContract</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">event</span> CreatorDeploy <span class="token punctuation">(</span><span class="token builtin">address</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">address</span> <span class="token keyword">public</span> _targetaddr<span class="token punctuation">;</span>
	
	<span class="token keyword">function</span> <span class="token function">deployTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token punctuation">&#123;</span>
		Target _contract <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Target</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">emit</span> <span class="token function">CreatorDepoly</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span>_contract<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		_tragetaddr <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span>_contract<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	
	<span class="token keyword">function</span> <span class="token function">destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">selfdestruct</span><span class="token punctuation">(</span><span class="token keyword">payable</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// contract C</span>
<span class="token keyword">contract</span> <span class="token class-name">C</span> <span class="token punctuation">&#123;</span>
	<span class="token builtin">address</span> <span class="token keyword">public</span> owner<span class="token punctuation">;</span>
	<span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		owner <span class="token operator">=</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	
	<span class="token keyword">function</span> <span class="token function">destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">public</span> <span class="token punctuation">&#123;</span>
		<span class="token keyword">selfdestruct</span><span class="token punctuation">(</span><span class="token keyword">payable</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="EVM-虚拟机"><a href="#EVM-虚拟机" class="headerlink" title="EVM 虚拟机"></a>EVM 虚拟机</h2><p><strong>EVM 虚拟机是一个基于栈的虚拟机</strong>，每一条指令都会有操作数和操作符</p>
<ul>
<li>opcode 表示这条指令是干什么的</li>
</ul>
<p>因为有些攻击合约不是开源的，就需要能看懂 Solidity 汇编代码，看懂机器指令</p>
<h3 id="内存模型（Memory-Model）"><a href="#内存模型（Memory-Model）" class="headerlink" title="内存模型（Memory Model）"></a>内存模型（Memory Model）</h3><p>在 EVM 中分成两大类 Memory：</p>
<ul>
<li>non-volatile：非易逝性——持久化存储</li>
<li>volatile：易逝——非持久化存储</li>
</ul>
<p>持久化存储：智能合约执行完后，数据依然存在的</p>
<p>非持久化存储：智能合约代码执行完毕后，数据消失不见</p>
<h4 id="non-volatile——持久化存储："><a href="#non-volatile——持久化存储：" class="headerlink" title="non-volatile——持久化存储："></a>non-volatile——持久化存储：</h4><p>持久化存储包括以下内容：</p>
<ul>
<li>code ：代码</li>
<li>storage：在智能合约的 Account 里来保存合约状态。（智能合约也是一个 Account）</li>
</ul>
<h4 id="volatile——非持久化存储："><a href="#volatile——非持久化存储：" class="headerlink" title="volatile——非持久化存储："></a>volatile——非持久化存储：</h4><p>非持久化存储包括：</p>
<ul>
<li>stack 栈</li>
<li>args 参数</li>
<li>memory 临时变量</li>
</ul>
<p>在 EVM 机器指令中，有专门的指令来操作 Memory 和 Storage 的。</p>
<h3 id="storage"><a href="#storage" class="headerlink" title="storage"></a>storage</h3><p><strong>Storage 实际上是一个 key-value 的映射关系</strong></p>
<p>Storage 在一个智能合约中很大，都有其 persistent storage（持久存储），一个 key-value 的映射</p>
<p><strong>存在：key^256^ -&gt; 32 bytes</strong></p>
<p>Storage 中的 key 是由 slot（插槽）计算而来的</p>
<h4 id="操作-Storage"><a href="#操作-Storage" class="headerlink" title="操作 Storage"></a>操作 Storage</h4><ul>
<li><strong>SSTORE：</strong>从堆栈中加载 key 和 value ，然后将32字节值保存到 key 位置</li>
<li><strong>SLOAD：</strong>从堆栈加载 key ，从存储中获取值，然后压入堆栈</li>
</ul>
<h3 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h3><p> Memory：<code>`mstore(p ,v) -&gt; mem[p..(p+32)) := v</code></p>
<p><strong>在 Memory 区域的前一部分字节是作为保留的，不可操作</strong></p>
<p>规定：<strong>在0x40的 4 个字节始终保存的是下一个可用的 Memory 地址</strong></p>
<p>所以在 Solidity 内联汇编（assembly代码块）中出现<code>mload(0x40)</code>的含义其实就是<strong>获取下一个可用操作 Memory opset 是多少</strong></p>
<h2 id="Call-amp-Delegatecall"><a href="#Call-amp-Delegatecall" class="headerlink" title="Call &amp; Delegatecall"></a>Call &amp; Delegatecall</h2><ul>
<li><strong>Call：</strong>调用另一个智能合约中的函数</li>
<li><strong>Delegatecall：</strong> 调用另一个智能合约内的函数，<strong><em>同时使用自己的存储和合约</em></strong>（这里涉及到一个细节：使用 Delegatecall 修改合约 A 的状态变量时，是根据插槽位置，而并非变量名修改的）</li>
</ul>
<p><img src="../images/登链-第二课/image-20231106162949359.png" alt="image-20231106162949359"></p>
<h2 id="Proxy-amp-Logic（Implementation）Contract-（代理和逻辑（实施）合约）"><a href="#Proxy-amp-Logic（Implementation）Contract-（代理和逻辑（实施）合约）" class="headerlink" title="Proxy &amp; Logic（Implementation）Contract （代理和逻辑（实施）合约）"></a>Proxy &amp; Logic（Implementation）Contract （代理和逻辑（实施）合约）</h2><p><img src="../images/登链-第二课/image-20231106163428536.png" alt="image-20231106163428536"></p>
<p>代理合约安全学习网址：<a target="_blank" rel="noopener" href="https://proxies.yacademy.dev/pages/security-guide/">https://proxies.yacademy.dev/pages/security-guide/</a></p>
<h2 id="Low-level-Call"><a href="#Low-level-Call" class="headerlink" title="Low-level Call"></a>Low-level Call</h2><ul>
<li>Contract Call：<code>contract.function()</code>——自动传递异常 contract call 底层也是通过 low-level call 的方式调用函数的，但是编译器已经帮我们做出了判断</li>
<li>Solidity 提供的通过<code>address.call()</code>的 low-level call （低级调用）形式：<strong>low-level call 本身不传递异常</strong><ul>
<li>low-level call 有两个<strong>返回值</strong>，<strong>一个是调用是否成功，一个是调用的返回值</strong>。low-level call 调用失败会在第一个返回值返回 false，但是<strong>不会导致交易回滚</strong>，所以要对 low-level call 的返回值进行检验，才能判断是否成功转移 Token。</li>
</ul>
</li>
</ul>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://q1ngying.cn">Q1ngying</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://q1ngying.cn/2023/11/06/%E7%99%BB%E9%93%BE-%E7%AC%AC%E4%BA%8C%E8%AF%BE/">https://q1ngying.cn/2023/11/06/%E7%99%BB%E9%93%BE-%E7%AC%AC%E4%BA%8C%E8%AF%BE/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://q1ngying.cn" target="_blank">Q1ngying</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Security/">Security</a><a class="post-meta__tags" href="/tags/Solidity/">Solidity</a></div><div class="post-share"><div class="social-share" data-image="/img/butterfly-icon.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="prev-post pull-left" href="/2023/11/06/DeFi%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/" title="DeFi基础概念"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">DeFi基础概念</div></div></a><a class="next-post pull-right" href="/2023/11/06/%E7%99%BB%E9%93%BE-%E7%AC%AC%E4%B8%80%E8%AF%BE/" title="登链-第一课"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">登链-第一课</div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a href="/2023/09/26/Contract-Size-Check/" title="Contract Size Check"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-09-26</div><div class="title">Contract Size Check</div></div></a><a href="/2023/10/08/%E6%8A%A2%E8%B7%91/" title="抢跑"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-08</div><div class="title">抢跑</div></div></a><a href="/2023/11/06/%E7%99%BB%E9%93%BE-%E7%AC%AC%E4%B8%80%E8%AF%BE/" title="登链-第一课"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-06</div><div class="title">登链-第一课</div></div></a><a href="/2024/03/30/%E9%87%8D%E5%85%A5/" title="重入"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-03-30</div><div class="title">重入</div></div></a><a href="/2023/10/08/%E9%87%8D%E6%94%BE/" title="重放"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-10-08</div><div class="title">重放</div></div></a><a href="/2024/01/16/AlienCodex-wp/" title="AlienCodex-wp"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-16</div><div class="title">AlienCodex-wp</div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info is-center"><div class="avatar-img"><img src="/img/butterfly-icon.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">Q1ngying</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">76</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">29</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">29</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/q1ngying"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/q1ngying" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a><a class="social-icon" href="https://weibo.com" target="_blank" title="微博"><i class="fab fa-weibo" style="color: #24292e;"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%88%E7%BA%A6%E5%9C%B0%E5%9D%80%E9%A2%84%E6%B5%8B"><span class="toc-number">1.</span> <span class="toc-text">合约地址预测</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CREATE-%E8%81%94%E5%90%88-CREATE2-%E6%94%BB%E5%87%BB"><span class="toc-number">2.</span> <span class="toc-text">CREATE 联合 CREATE2 攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E5%90%88%E7%BA%A6%E8%87%AA%E9%94%80%E6%AF%81%E7%9A%84%E5%B0%8F%E7%9F%A5%E8%AF%86%EF%BC%9A"><span class="toc-number">2.1.</span> <span class="toc-text">关于合约自销毁的小知识：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CREATE-%E5%88%9B%E5%BB%BA%E5%90%88%E7%BA%A6%EF%BC%9A"><span class="toc-number">2.2.</span> <span class="toc-text">CREATE 创建合约：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CREATE2-%E5%88%9B%E5%BB%BA%E5%90%88%E7%BA%A6"><span class="toc-number">2.3.</span> <span class="toc-text">CREATE2 创建合约</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CREATE-%E5%92%8C-CREATE2-%E8%81%94%E5%90%88%E4%BD%BF%E7%94%A8%E6%94%BB%E5%87%BB"><span class="toc-number">2.4.</span> <span class="toc-text">CREATE 和 CREATE2 联合使用攻击</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EVM-%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">3.</span> <span class="toc-text">EVM 虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%EF%BC%88Memory-Model%EF%BC%89"><span class="toc-number">3.1.</span> <span class="toc-text">内存模型（Memory Model）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#non-volatile%E2%80%94%E2%80%94%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8%EF%BC%9A"><span class="toc-number">3.1.1.</span> <span class="toc-text">non-volatile——持久化存储：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#volatile%E2%80%94%E2%80%94%E9%9D%9E%E6%8C%81%E4%B9%85%E5%8C%96%E5%AD%98%E5%82%A8%EF%BC%9A"><span class="toc-number">3.1.2.</span> <span class="toc-text">volatile——非持久化存储：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#storage"><span class="toc-number">3.2.</span> <span class="toc-text">storage</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%93%8D%E4%BD%9C-Storage"><span class="toc-number">3.2.1.</span> <span class="toc-text">操作 Storage</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Memory"><span class="toc-number">3.3.</span> <span class="toc-text">Memory</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Call-amp-Delegatecall"><span class="toc-number">4.</span> <span class="toc-text">Call &amp; Delegatecall</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Proxy-amp-Logic%EF%BC%88Implementation%EF%BC%89Contract-%EF%BC%88%E4%BB%A3%E7%90%86%E5%92%8C%E9%80%BB%E8%BE%91%EF%BC%88%E5%AE%9E%E6%96%BD%EF%BC%89%E5%90%88%E7%BA%A6%EF%BC%89"><span class="toc-number">5.</span> <span class="toc-text">Proxy &amp; Logic（Implementation）Contract （代理和逻辑（实施）合约）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Low-level-Call"><span class="toc-number">6.</span> <span class="toc-text">Low-level Call</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/17/MakerDAO-Abacus/" title="MakerDAO-Abacus">MakerDAO-Abacus</a><time datetime="2024-07-17T07:06:42.000Z" title="发表于 2024-07-17 15:06:42">2024-07-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/17/MakerDAO-Clip/" title="MakerDAO-Clip">MakerDAO-Clip</a><time datetime="2024-07-17T07:06:32.000Z" title="发表于 2024-07-17 15:06:32">2024-07-17</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/15/MakerDAO-Join/" title="MakerDAO-Join">MakerDAO-Join</a><time datetime="2024-07-15T07:34:45.000Z" title="发表于 2024-07-15 15:34:45">2024-07-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/07/15/MakerDAO-Vat/" title="MakerDAO-Vat">MakerDAO-Vat</a><time datetime="2024-07-15T07:34:34.000Z" title="发表于 2024-07-15 15:34:34">2024-07-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2024/06/11/Storage%20%E8%BF%9B%E9%98%B6%E2%80%94%E2%80%94%E9%80%9A%E8%BF%87%E5%BC%95%E7%94%A8%20Storage%20%E6%8F%90%E9%AB%98%20gas%20%E5%88%A9%E7%94%A8%E7%8E%87/" title="Storage 进阶——通过引用 Storage 提高 gas 利用率">Storage 进阶——通过引用 Storage 提高 gas 利用率</a><time datetime="2024-06-11T09:13:23.000Z" title="发表于 2024-06-11 17:13:23">2024-06-11</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/back1.webp);"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By Q1ngying</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div></div></body></html>
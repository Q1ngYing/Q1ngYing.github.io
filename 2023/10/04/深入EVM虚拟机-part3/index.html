<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/icons8-autumn-material-filled-32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/icons8-autumn-material-filled-16.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="前言： 在第 3 部分中，将深入探讨合约存储的工作原理。通过提供一些思维模式来帮助理解并深入了解存储插槽包装">
<meta property="og:type" content="article">
<meta property="og:title" content="深入EVM虚拟机-part3">
<meta property="og:url" content="http://example.com/2023/10/04/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/index.html">
<meta property="og:site_name" content="Q1ngying">
<meta property="og:description" content="前言： 在第 3 部分中，将深入探讨合约存储的工作原理。通过提供一些思维模式来帮助理解并深入了解存储插槽包装">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/image-20231004175726799.png">
<meta property="og:image" content="http://example.com/images/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/640-16964106582043.png">
<meta property="og:image" content="http://example.com/images/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/640-16964110953406.png">
<meta property="og:image" content="http://example.com/images/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/640-16964111921169.png">
<meta property="og:image" content="http://example.com/images/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/640-169641163841012.png">
<meta property="og:image" content="http://example.com/images/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/640-169641211792415.png">
<meta property="og:image" content="http://example.com/images/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/640-169641217516118.png">
<meta property="article:published_time" content="2023-10-04T09:54:38.000Z">
<meta property="article:modified_time" content="2023-11-06T11:34:13.547Z">
<meta property="article:author" content="Q1ngying">
<meta property="article:tag" content="Solidity">
<meta property="article:tag" content="EVM">
<meta property="article:tag" content="EVM 学习">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/image-20231004175726799.png">

<link rel="canonical" href="http://example.com/2023/10/04/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>深入EVM虚拟机-part3 | Q1ngying</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Q1ngying</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">清影的个人站</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/04/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="Q1ngying">
      <meta itemprop="description" content="今朝梦醒与君别，遥盼春风寄相思">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Q1ngying">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          深入EVM虚拟机-part3
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-10-04 17:54:38" itemprop="dateCreated datePublished" datetime="2023-10-04T17:54:38+08:00">2023-10-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-11-06 19:34:13" itemprop="dateModified" datetime="2023-11-06T19:34:13+08:00">2023-11-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/learn/" itemprop="url" rel="index"><span itemprop="name">learn</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solidity/" itemprop="url" rel="index"><span itemprop="name">Solidity</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/EVM/" itemprop="url" rel="index"><span itemprop="name">EVM</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>3.7k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>12 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><strong>前言：</strong> 在第 3 部分中，将深入探讨<strong>合约存储的工作原理</strong>。通过提供一些思维模式来帮助理解并深入了解<strong>存储插槽包装</strong></p>
<span id="more"></span>

<h1 id="存储基础"><a href="#存储基础" class="headerlink" title="存储基础"></a>存储基础</h1><p>在 <a target="_blank" rel="noopener" href="https://programtheblockchain.com/posts/2018/03/09/understanding-ethereum-smart-contract-storage">Program the Blockchain</a>这篇文章中，对存储基础知识进行了高度概括，建议可以先阅读这篇文章。</p>
<h2 id="1、数据结构"><a href="#1、数据结构" class="headerlink" title="1、数据结构"></a>1、数据结构</h2><p><strong>合约存储是一个简单的键值的映射</strong>。它将一个 32 字节的 key 映射到一个 32 字节的 value。鉴于我们的 key 是 32 字节大小，我们最多可以有（2^256）- 1 个 key</p>
<p><strong>所有的值都被初始化为 0，0没有被明确地存储。</strong>因为 <code>2^256</code> 大约是已知的、可观测的宇宙中的原子数量。没有一台计算机可以容纳这么多的数据。这也是将一个存储值设置为零的原因，因为该键值不再需要由网络上的结点存储，所以可以退还一些 gas。</p>
<p>从概念上讲，存储可以被看作是一个天文数字的大阵列。我们的第一个二进制值为 0 的 key 代表阵列中的第 0 项，二进制值为 1 的 key 代表阵列中的第 1 项，等等。</p>
<p><img src="/../images/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/image-20231004175726799.png" alt="image-20231004175726799"></p>
<h2 id="2、定长变量"><a href="#2、定长变量" class="headerlink" title="2、定长变量"></a>2、定长变量</h2><p><strong>被声明为存储变量的合约变量可以分为定长和不定长两种。</strong>我们将专注于定长变量，以及 EVM 如何将多个变量装入一个 32 字节的插槽中。要了解更多关于不定长变量，可以看 “Program the Blockchain” 的文章。</p>
<p>现在我们知道存储是一种键值映射，接下来的问题是知道：如何将 key 分配给 value。假设我们有如下的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">contract StorageTest &#123;</span><br><span class="line">	uint256 value1;</span><br><span class="line">	uint256[2] value2;</span><br><span class="line">	uint256 value3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>鉴于这些都是定长变量，EVM 可以使用保存的存储位置（keys），从插槽 0 （key 的二进制值为 0）开始，线性地向前移动到插槽 1、2 等。这是将根据变量在合约中的声明顺序来做的。第一个声明的存储变量将被存储在槽位 0。在这个例子中，插槽 0 将存放变量”value1”，变量”value2”是一个定长为 2 的数组，所以将占用插槽 1 和 插槽 2 ，最后插槽 3 将存放变量”value3”。</p>
<p><img src="/../images/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/640-16964106582043.png" alt="图片"></p>
<p>接下来再看另一个类型的合约，了解以下它的变量是如何存储的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">contract StorageTest&#123;</span><br><span class="line">	uint32 value1;</span><br><span class="line">	uint32 value2;</span><br><span class="line">	uint64 value3;</span><br><span class="line">	uint128 value4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个例子和上面的例子（占用 0~3 四个插槽）不同，这个例子只占用存储插槽 0，关键的区别在于<strong>用于变量的单位类型</strong>。之前所有的变量都是 <code>uint256</code> 类型，代表 32 个字节的数据。这里我们使用<code>uint32、uint64、uint128</code>分别代表 4、8、16 字节的数据。</p>
<h2 id="3、插槽包装"><a href="#3、插槽包装" class="headerlink" title="3、插槽包装"></a>3、插槽包装</h2><p>这就是插槽包装（slot packing）的由来。Solidity 编译器知道它可以在一个存储槽中存储 32 字节的数据。因此，当 “uint32 value1”，只占 4 个字节，被存储在插槽 0 时，当下一个变量被读入时，编译器会看它是否能被打包到当前的存储插槽。鉴于插槽 0 有 32 个字节的空间，而 value1 只占用了其中的 4 个字节，只要下一个变量的大小小于 28 个字节，它也将被装入插槽 0。在上面的例子中，我们从 0 存储插槽的 32 字节开始。</p>
<ul>
<li>value1 存储在插槽 0，占 4 个字节。</li>
<li>插槽 0 有 28 个字节的剩余空间</li>
<li>value2 是 4 个字节，小于 28 个字节，因此它可以被存储在插槽 0 中。</li>
<li>插槽 0 有 24 个字节的剩余</li>
<li>value3 是 8 个字节，小于 24 个字节，因此它也被存储插槽 0 中。</li>
<li>插槽 0 仍有 16 个字节的剩余</li>
<li>value4 是 16 个字节，正好等于 16 个字节，因此它仍被存储在插槽 0 中。</li>
</ul>
<p><em>需要注意的是：uint8 是最小的 Solidity 类型，因此在打包时不能小于 1 字节（8位）。</em></p>
<p>下图显示了插槽 0 中的 32 字节数据如何保存所有 4 个变量的：</p>
<p><img src="/../images/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/640-16964110953406.png" alt="图片"></p>
<h2 id="4、EVM-存储操作码"><a href="#4、EVM-存储操作码" class="headerlink" title="4、EVM 存储操作码"></a>4、EVM 存储操作码</h2><h3 id="1）SSTORE"><a href="#1）SSTORE" class="headerlink" title="1）SSTORE"></a>1）SSTORE</h3><p>SSTORE，他从调用栈中接收了一个 32 字节的键和一个 32 字节的值，并将 32 字节的值存储在该 32 字节的键位置。可以在 <a target="_blank" rel="noopener" href="https://noxx.substack.com/p/evm-deep-dives-the-path-to-shadowy-3ea#:~:text=location.%20Check%20out-,this,-EVM%20playground%20to">EVM PlayPlayground</a> 里查看它的运行原理。</p>
<p><img src="/../images/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/640-16964111921169.png" alt="图片"></p>
<h3 id="2）SLOAD"><a href="#2）SLOAD" class="headerlink" title="2）SLOAD"></a>2）SLOAD</h3><p>SLOAD，它从调用栈中接收一个 32 字节的键，并将存储在该 32 字节的键（key）位置的 32 字节的值（value）推到调用栈。可以在 <a target="_blank" rel="noopener" href="https://noxx.substack.com/p/evm-deep-dives-the-path-to-shadowy-3ea#:~:text=stack.%20Check%20out-,this,-EVM%20playground%20to">EVM PlayPlayground</a>里查看它的运行原理。</p>
<p><strong>如果 SSTORE 和 SLOAD 只处理 32 字节的值，那怎么能提取一个已经打包装入 32 字节插槽的变量呢？</strong></p>
<h1 id="存储和检索打包的变量"><a href="#存储和检索打包的变量" class="headerlink" title="存储和检索打包的变量"></a>存储和检索打包的变量</h1><p>下面用一个合约来仿照之前给出的例子。合约中我们增加了一个设置变量值的存储函数，它通过读取一个变量来进行一些运算操作。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//SPDX-License-Identifier: GPL-3.0</span><br><span class="line">pragma solidity &gt;=0.7.0 &lt;0.9.0;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line">*@title Storage</span><br><span class="line">*@dev Store &amp; retrieve value in a variable</span><br><span class="line">*/</span><br><span class="line">contract StorageTwo &#123;</span><br><span class="line">	</span><br><span class="line">	uint32 value1;</span><br><span class="line">	uint32 value2;</span><br><span class="line">	uint64 value3;</span><br><span class="line">	uint128 value4;</span><br><span class="line">	</span><br><span class="line">	function store() public &#123;</span><br><span class="line">		value1 = 1;</span><br><span class="line">		value2 = 22;</span><br><span class="line">		value3 = 333;</span><br><span class="line">		value4 = 444;</span><br><span class="line">		</span><br><span class="line">		uint96 value5 = value3 + uint32(666);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>合约中的 store() 函数会执行前面我们存在疑问的操作。在一个插槽中存储多个变量而不覆盖现有数据，并从 32 字节的插槽中检索一个变量的特定字节。</p>
<p>让我们先看看插槽 0 的结束状态，下面是它的二进制和十六进制的表示。十六进制数字被机器识别为二进制数字，并且在 slot packing 中使用了一些位操作。 </p>
<p><img src="/../images/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/640-169641163841012.png" alt="图片"></p>
<p>十六进制的 0x115c 十进制表示为 4444，0x14d 为 333，0x16 为 22，0x01 为 1。这些对应于我们在 Solidity 代码中看到的 value 值。一个插槽可以容纳 32 个字节的数据，也就是说 64 个十六进制的字符或 256 位，正好容纳上面的 4 个变量。</p>
<h2 id="1、位运算"><a href="#1、位运算" class="headerlink" title="1、位运算"></a>1、位运算</h2><p>Slot packing 使用了 3 个位运算操作“AND、OR 和 NOT。对于 3 个具有相同命名的 EVM 操作码。</p>
<h3 id="1）AND"><a href="#1）AND" class="headerlink" title="1）AND"></a>1）AND</h3><p>在 AND 操作中，第一个数字的第一位与第二个数字的第一位进行比较。如果两个值都是 1.那么 AND 返回真，结果为 1，反之为 0，以此类推。</p>
<p><img src="/../images/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/640-169641211792415.png" alt="图片"></p>
<h3 id="2）OR"><a href="#2）OR" class="headerlink" title="2）OR"></a>2）OR</h3><p>在 OR 运算中，只要其中一个值为 1 就返回真，反之为 0。</p>
<p><img src="/../images/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/640-169641217516118.png" alt="图片"></p>
<h3 id="3）NOT"><a href="#3）NOT" class="headerlink" title="3）NOT"></a>3）NOT</h3><p>NOT 略有不同，他只接收一个值，而不是对 2 个数进行比较。NOT 对每个为进行逻辑否定，进行取反。</p>
<p>现在让我们来看看这些位运算操作是如何在上述例子中实际使用的。</p>
<h2 id="2、插槽操作-插槽包装-SSTORE"><a href="#2、插槽操作-插槽包装-SSTORE" class="headerlink" title="2、插槽操作-插槽包装 SSTORE"></a>2、插槽操作-插槽包装 SSTORE</h2><p>注意代码的第 10 行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">value2 = 22;</span><br></pre></td></tr></table></figure>

<p>此时 value1已经被存储在插槽 0 中，我们需要将一些额外的数据打包到同一个插槽中，其中 value3 和 value4 存储逻辑相同。我们将从理论上来解释这是如何做到的，并将提供一个 EVM playground 实例进一步探索。</p>
<p>从下面的值开始：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0x00000016		=	22 (value2)</span><br><span class="line">0x00		    =	0	(slot 0)</span><br><span class="line">0x04			=   4	(4 个字节，value2 的起始位置)</span><br><span class="line">0x0100			=	256	(1 字节的最大值 255 + 1)</span><br><span class="line">0xffffffff		=	4294967295 (二进制为 1 的大小为 4 个字节的数)</span><br></pre></td></tr></table></figure>

<p>0xffffffff 等于二进制的 11111111111111111111111111111111。EVM 做的第一件事是使用 EXP 操作码，它接收一个基数整数和一个指数，并返回结果数值。这里 0x0100 作为基整数，代表一个 1 字节的偏移量，指数为 0x04，其是 “value2” 的起始位置。下图显示了为什么返回的值是有用的。（0x100 的 0x04 次幂，也就是 0x100000000）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EXP 操作码产生值0x0000000000000000000000000000000000000000000000000000000100000000</span><br><span class="line"></span><br><span class="line">如果用这个值乘以 value2，就会得到想要的值 0x016 在 32 字节插槽的位置。0x0000000000000000000000000000000000000000000000000000001600000000</span><br></pre></td></tr></table></figure>

<p>我们可以看到，EXP 函数的返回结果能够在正确的位置（4 字节偏移，插槽从右往左填充，相当于从右到左偏移八位）插入数据 0x16 。然而，我们还暂时不能写入这个值，因为它将覆盖已经被存储的 value1。这就是位掩码发挥的地方了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">EXP 操作码产生值</span><br><span class="line">0x0000000000000000000000000000000000000000000000000000000100000000</span><br><span class="line"></span><br><span class="line">如果用这个值乘以 0xffffffff，可以得到 value2 所在的 4 个字节的位掩码。</span><br><span class="line">0x000000000000000000000000000000000000000000000000ffffffff00000000</span><br><span class="line"></span><br><span class="line">如果对这个值进行按位非运算，我们会得到一个除了 value2 所在的 4 个字节之外的所有字节的位掩码。</span><br><span class="line">0xffffffffffffffffffffffffffffffffffffffffffffffff00000000ffffffff</span><br><span class="line"></span><br><span class="line">在插槽 0 中使用 SSLOAD（注意值 value1 存在于返回的数据中）</span><br><span class="line">0x0000000000000000000000000000000000000000000000000000000000000001</span><br><span class="line"></span><br><span class="line">对插槽 0 中的数据和位掩码使用 AND 将返回分配给 value2 的 4 个字节之外的所有数据，并将位于 value2 的 4 个字节中的所有数据清零。</span><br><span class="line">0x0000000000000000000000000000000000000000000000000000000000000001</span><br></pre></td></tr></table></figure>

<p>上面显示了如何利用位掩码从一个插槽中获取除了待写入的数据外的所有的数据。在这个例子中，value2 所用的字节已经被设置为 0，但是如果没有被设置，这些数据就将会被抹去（位掩码：用一串二进制数字（掩码）去操作另一串二进制数字。这里及用 AND 操作码的与运算，通过 0 和其他数想与都为 0 的情况抹去不需要的数据）。</p>
<p>下面是另一个例子通过同样的过程，了解一下如果所有 4 个值都已经被存储，我们把 value2 从 22 更新到 99 会发生，现有的 0x016 值被清零。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">位掩码</span><br><span class="line">0xffffffffffffffffffffffffffffffffffffffffffffffff00000000ffffffff</span><br><span class="line"></span><br><span class="line">在存储所有值后在插槽 0 上使用 SSLOAD</span><br><span class="line">0x0000000000000000000000000000115c000000000000014d0000001600000001</span><br><span class="line"></span><br><span class="line">对插槽 0 中的数据和位掩码使用 AND 将向我们返回分配给 value2 的 4 个字节之外的所有数据，并将位于 value2 的 4 个字节中的所有数据清零</span><br><span class="line">0x0000000000000000000000000000115c000000000000014d0000001600000001</span><br></pre></td></tr></table></figure>

<p>看到这里，你可能已经在考虑按位或运算怎么样帮助组合我们已有的值了。步骤如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Value2</span><br><span class="line">0x00000016</span><br><span class="line"></span><br><span class="line">0xffffffff 的二进制表示为 4 字节全 1</span><br><span class="line">0xffffffff</span><br><span class="line"></span><br><span class="line">对 Value2 和 0xffffffff 进行按位与操作，确保如果提供的值大于4个字节，它将被裁剪下来</span><br><span class="line">0x00000016</span><br><span class="line"></span><br><span class="line">EXP 操作码产生值</span><br><span class="line">0x0000000000000000000000000000000000000000000000000000000100000000</span><br><span class="line"></span><br><span class="line">如果用这个值乘以 value2 ，我们将在 32 字节插槽中的正确位置得到我们想要的值 0x016 </span><br><span class="line">0x0000000000000000000000000000000000000000000000000000001600000000</span><br><span class="line"></span><br><span class="line">使用前一个位掩码部分的结果</span><br><span class="line">0x0000000000000000000000000000000000000000000000000000000000000001</span><br><span class="line"></span><br><span class="line">对前面的 2 个值使用按位或操作将 value2 存储在指定位置，同时保留已存储在插槽 0 中的所有值</span><br><span class="line">0x0000000000000000000000000000000000000000000000000000001600000001</span><br></pre></td></tr></table></figure>

<p>现在我们可以在插槽 0 的 32 字节值上使用 SSTORE，它包含了 value1 和 value2 在正确字节位置的数据。</p>
<h2 id="3、插槽操作-检索一个打包的变量-SLOAD"><a href="#3、插槽操作-检索一个打包的变量-SLOAD" class="headerlink" title="3、插槽操作 - 检索一个打包的变量 SLOAD"></a>3、插槽操作 - 检索一个打包的变量 SLOAD</h2><p>让我们来看第 22 行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uint96 value5 = value3 + uint32(666)</span><br></pre></td></tr></table></figure>

<p>实际上我们只需要关心 value3 是怎么被检索到的。下面就是取出 value3 需要的数据的过程，我们用跟上边的不太一样的数据来展示。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0x00                =   0  (slot 0)</span><br><span class="line">0x08                =   8  (8 个字节，value3 的起始位置)</span><br><span class="line">0x0100              =   256 (1 字节的最大值 255 + 1)</span><br><span class="line">0xffffffffffffffff  =    (二进制全为 1 的大小为 8 个字节的数)</span><br><span class="line">0x0000000000000000000000000000115c000000000000014d0000001600000001  =   slot 0 value</span><br></pre></td></tr></table></figure>

<p>可以看到大部分内容将在进行一些修改后被重新用于检索。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0x0100 和 0x08 上的 EXP 操作码产量0x0000000000000000000000000000000000000000000000010000000000000000</span><br><span class="line">存储插槽 0 上的 SSLOAD0x0000000000000000000000000000115c000000000000014d0000001600000001</span><br><span class="line">DIV 操作码将插槽 0 的值除以 EXP 的值，这实际上是将 value1 和 value2 所使用的底部 8 个字节修剪掉。0x00000000000000000000000000000000000000000000115c000000000000014d</span><br><span class="line">前 8 个字节的位掩码0x000000000000000000000000000000000000000000000000ffffffffffffffff</span><br><span class="line">在此位掩码上使用 AND 和 DIV 的返回值有效地修剪/清零前 16 个字节并返回给8 个字节的变量&quot;value3&quot;0x000000000000000000000000000000000000000000000000000000000000014d</span><br></pre></td></tr></table></figure>

<p>我们已经从包装的插槽 0 中检索到 value3。十六进制的 0x14d 十进制为 333，这就是我们在代码中所设定的。</p>
<p>位掩码和位操作再次被用来帮助从 32 字节的插槽中提取特定的字节。而这个值现在在栈中，然后可以被 EVM 用来计算 “value3 + uint32(666)”。</p>
<p>刚才探索的 store() 函数中执行的所有操作码都放到了 <a target="_blank" rel="noopener" href="https://noxx.substack.com/p/evm-deep-dives-the-path-to-shadowy-3ea#:~:text=them%20into%20an-,EVM%20playground,-.%20Here%20you%E2%80%99ll%20be">EVM Playgrpund 中</a>，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line">// --------------------------------</span><br><span class="line">// Solidity Line 17 - &quot;value1 = 1;&quot;</span><br><span class="line">// --------------------------------</span><br><span class="line">PUSH1 0x01</span><br><span class="line">PUSH1 0x00</span><br><span class="line">DUP1</span><br><span class="line">PUSH2 0x0100</span><br><span class="line">EXP</span><br><span class="line">DUP2</span><br><span class="line">SLOAD</span><br><span class="line">DUP2</span><br><span class="line">PUSH4 0xffffffff</span><br><span class="line">MUL</span><br><span class="line">NOT</span><br><span class="line">AND</span><br><span class="line">SWAP1</span><br><span class="line">DUP4</span><br><span class="line">PUSH4 0xffffffff</span><br><span class="line">AND</span><br><span class="line">MUL</span><br><span class="line">OR</span><br><span class="line">SWAP1</span><br><span class="line">SSTORE</span><br><span class="line">POP</span><br><span class="line"></span><br><span class="line">// ---------------------------------</span><br><span class="line">// Solidity Line 18 - &quot;value2 = 22;&quot;</span><br><span class="line">// ---------------------------------</span><br><span class="line">PUSH1 0x16 // value2 = 22 decimal = 0x16 in hex</span><br><span class="line"></span><br><span class="line">PUSH1 0x00 // slot 0 - storage location for &quot;value2&quot;</span><br><span class="line"></span><br><span class="line">PUSH1 0x04 // 4 bytes in - start position for &quot;value2&quot;</span><br><span class="line"></span><br><span class="line">PUSH2 0x0100 // 0x100 in hex = 256 in decimal, 256 bits in 1 byte </span><br><span class="line"></span><br><span class="line">EXP // exponent of 0x0100 &amp; 0x04 = 0x100000000       </span><br><span class="line">    </span><br><span class="line">DUP2 // duplicate 0x00 to top of stack</span><br><span class="line"></span><br><span class="line">SLOAD // load data at slot 0</span><br><span class="line"></span><br><span class="line">DUP2 // duplicate exponent of 0x0100 &amp; 0x04 = 0x100000000</span><br><span class="line"></span><br><span class="line">PUSH4 0xffffffff // bitmask 4 bytes length      </span><br><span class="line"></span><br><span class="line">MUL // multiply to get bitmask for the 8 bytes assigned to &quot;value2&quot;</span><br><span class="line"></span><br><span class="line">NOT // NOT operation to get bitmask for all bytes except the 8 bytes assigned to &quot;value2&quot;</span><br><span class="line"></span><br><span class="line">AND // AND of bitmask and slot 0 value to zero out values in the 8 bytes assigned to &quot;value2&quot; and retain all other values</span><br><span class="line"></span><br><span class="line">SWAP1 // bring 0x100000000 to top of the stack</span><br><span class="line"></span><br><span class="line">DUP4 // duplicate value2 value = 22 = 0x16</span><br><span class="line"></span><br><span class="line">PUSH4 0xffffffff // bitmask 4 bytes length </span><br><span class="line"></span><br><span class="line">AND // AND to ensure the value is no more than 4 bytes in length</span><br><span class="line"></span><br><span class="line">MUL // returns value2 at the correct position - 4 bytes in</span><br><span class="line"></span><br><span class="line">OR // OR with previous value and the value AND yielded on line 38 gives us the 32 bytes that need to be stored</span><br><span class="line"></span><br><span class="line">SWAP1 // slot 0 to top of the stack</span><br><span class="line"></span><br><span class="line">SSTORE // store the 32 byte value at slot 0</span><br><span class="line"></span><br><span class="line">POP // pop 0x16 off the stack</span><br><span class="line"></span><br><span class="line">// ----------------------------------</span><br><span class="line">// Solidity Line 19 - &quot;value3 = 333;&quot;</span><br><span class="line">// ----------------------------------</span><br><span class="line">PUSH2 0x014d</span><br><span class="line">PUSH1 0x00</span><br><span class="line">PUSH1 0x08</span><br><span class="line">PUSH2 0x0100</span><br><span class="line">EXP</span><br><span class="line">DUP2</span><br><span class="line">SLOAD</span><br><span class="line">DUP2</span><br><span class="line">PUSH8 0xffffffffffffffff</span><br><span class="line">MUL</span><br><span class="line">NOT</span><br><span class="line">AND</span><br><span class="line">SWAP1</span><br><span class="line">DUP4</span><br><span class="line">PUSH8 0xffffffffffffffff</span><br><span class="line">AND</span><br><span class="line">MUL</span><br><span class="line">OR</span><br><span class="line">SWAP1</span><br><span class="line">SSTORE</span><br><span class="line">POP</span><br><span class="line"></span><br><span class="line">// -----------------------------------</span><br><span class="line">// Solidity Line 20 - &quot;value4 = 4444;&quot;</span><br><span class="line">// -----------------------------------</span><br><span class="line">PUSH2 0x115c</span><br><span class="line">PUSH1 0x00</span><br><span class="line">PUSH1 0x10</span><br><span class="line">PUSH2 0x0100</span><br><span class="line">EXP</span><br><span class="line">DUP2</span><br><span class="line">SLOAD</span><br><span class="line">DUP2</span><br><span class="line">PUSH16 0xffffffffffffffffffffffffffffffff</span><br><span class="line">MUL</span><br><span class="line">NOT</span><br><span class="line">AND</span><br><span class="line">SWAP1</span><br><span class="line">DUP4</span><br><span class="line">PUSH16 0xffffffffffffffffffffffffffffffff</span><br><span class="line">AND</span><br><span class="line">MUL</span><br><span class="line">OR</span><br><span class="line">SWAP1</span><br><span class="line">SSTORE</span><br><span class="line">POP</span><br><span class="line"></span><br><span class="line">// ----------------------------------------------------------</span><br><span class="line">// Solidity Line 22 - &quot;uint64 value5 = value3 + uint32(666);&quot;</span><br><span class="line">// ----------------------------------------------------------</span><br><span class="line">PUSH1 0x00</span><br><span class="line"></span><br><span class="line">PUSH2 0x029a // uint32(666)</span><br><span class="line"></span><br><span class="line">PUSH4 0xffffffff // bitmask 4 bytes length</span><br><span class="line"></span><br><span class="line">AND // ensure uint32(666) does not exceed 8 bytes, trim if it does </span><br><span class="line"></span><br><span class="line">PUSH1 0x00 // slot 0 - location of value3</span><br><span class="line"></span><br><span class="line">PUSH1 0x08 // 8 bytes in - start position for &quot;value3&quot;</span><br><span class="line"></span><br><span class="line">SWAP1 // bring 0x00 to top of stack for SLOAD of slot 0</span><br><span class="line"></span><br><span class="line">SLOAD // load data at slot 0</span><br><span class="line"></span><br><span class="line">SWAP1 // bring 0x08 to top of stack for EXP</span><br><span class="line"></span><br><span class="line">PUSH2 0x0100 // 256 bits in 1 byte </span><br><span class="line"></span><br><span class="line">EXP // exponent of 0x0100 &amp; 0x08 = 0x10000000000000000</span><br><span class="line"></span><br><span class="line">SWAP1 // get slot 0 value to top of stack</span><br><span class="line"></span><br><span class="line">DIV // DIV of slot 0 value with 0x10000000000000000 remove bottom 8 bytes  </span><br><span class="line"></span><br><span class="line">PUSH8 0xffffffffffffffff // bitmask 8 bytes length </span><br><span class="line"></span><br><span class="line">AND // Zero out bytes outside of the 8 byte mask to return variable &quot;value3&quot;</span><br><span class="line"></span><br><span class="line">// To see the rest of the opcodes for this calculation recreate the contract in remix and enter debugging mode</span><br></pre></td></tr></table></figure>

<p>这篇文章我们深入了解存储插槽打包的工作原理，以及 EVM 是如何在 32 字节插槽的特定位置检索和存储字节的。尽管 EVM 的操作码 SLOAD &amp; SSTORE 只处理 32 字节的数据块，但我们可以使用位操作和位掩码来存储和加载我们想要的数据。</p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Q1ngying
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://example.com/2023/10/04/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part3/" title="深入EVM虚拟机-part3">http://example.com/2023/10/04/深入EVM虚拟机-part3/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Solidity/" rel="tag"># Solidity</a>
              <a href="/tags/EVM/" rel="tag"># EVM</a>
              <a href="/tags/EVM-%E5%AD%A6%E4%B9%A0/" rel="tag"># EVM 学习</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/10/01/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part2/" rel="prev" title="深入EVM虚拟机-part2">
      <i class="fa fa-chevron-left"></i> 深入EVM虚拟机-part2
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/10/06/%E6%B7%B1%E5%85%A5EVM%E8%99%9A%E6%8B%9F%E6%9C%BA-part4/" rel="next" title="深入EVM虚拟机-part4">
      深入EVM虚拟机-part4 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E5%9F%BA%E7%A1%80"><span class="nav-number">1.</span> <span class="nav-text">存储基础</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">1.1.</span> <span class="nav-text">1、数据结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E5%AE%9A%E9%95%BF%E5%8F%98%E9%87%8F"><span class="nav-number">1.2.</span> <span class="nav-text">2、定长变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E6%8F%92%E6%A7%BD%E5%8C%85%E8%A3%85"><span class="nav-number">1.3.</span> <span class="nav-text">3、插槽包装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4%E3%80%81EVM-%E5%AD%98%E5%82%A8%E6%93%8D%E4%BD%9C%E7%A0%81"><span class="nav-number">1.4.</span> <span class="nav-text">4、EVM 存储操作码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89SSTORE"><span class="nav-number">1.4.1.</span> <span class="nav-text">1）SSTORE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89SLOAD"><span class="nav-number">1.4.2.</span> <span class="nav-text">2）SLOAD</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E5%92%8C%E6%A3%80%E7%B4%A2%E6%89%93%E5%8C%85%E7%9A%84%E5%8F%98%E9%87%8F"><span class="nav-number">2.</span> <span class="nav-text">存储和检索打包的变量</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1%E3%80%81%E4%BD%8D%E8%BF%90%E7%AE%97"><span class="nav-number">2.1.</span> <span class="nav-text">1、位运算</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89AND"><span class="nav-number">2.1.1.</span> <span class="nav-text">1）AND</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89OR"><span class="nav-number">2.1.2.</span> <span class="nav-text">2）OR</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89NOT"><span class="nav-number">2.1.3.</span> <span class="nav-text">3）NOT</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2%E3%80%81%E6%8F%92%E6%A7%BD%E6%93%8D%E4%BD%9C-%E6%8F%92%E6%A7%BD%E5%8C%85%E8%A3%85-SSTORE"><span class="nav-number">2.2.</span> <span class="nav-text">2、插槽操作-插槽包装 SSTORE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3%E3%80%81%E6%8F%92%E6%A7%BD%E6%93%8D%E4%BD%9C-%E6%A3%80%E7%B4%A2%E4%B8%80%E4%B8%AA%E6%89%93%E5%8C%85%E7%9A%84%E5%8F%98%E9%87%8F-SLOAD"><span class="nav-number">2.3.</span> <span class="nav-text">3、插槽操作 - 检索一个打包的变量 SLOAD</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Q1ngying"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Q1ngying</p>
  <div class="site-description" itemprop="description">今朝梦醒与君别，遥盼春风寄相思</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">42</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/q1ngying" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;q1ngying" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:q1ngying@163.com" title="E-Mail → mailto:q1ngying@163.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2023-09 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Q1ngying</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">122k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">6:47</span>
</div>

<div class="powered-by">
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <i class="fa fa-user-md"></i>
    <span id="busuanzi_container_site_uv">
        本站访客数:<span id="busuanzi_value_site_uv"></span>人
    </span>
    <span class="post-meta-divider">|</span>
    <span id="busuanzi_container_site_pv">
        本站访问量<span id="busuanzi_value_site_pv"></span>人次
    </span>
</div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='255,255,255' opacity='1' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>

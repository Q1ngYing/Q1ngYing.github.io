<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>UniswapV2合约 | Q1ngying</title><meta name="author" content="Q1ngying"><meta name="copyright" content="Q1ngying"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#FFFFFF"><meta name="description" content="深入理解 Uniswap v2 合约代码来源：https:&#x2F;&#x2F;hackmd.io&#x2F;@adshao&#x2F;rk7nI-EG9 合约架构：Unsiwap-v2 合约主要分为两类：core 合约和 periphery 合约。其中 ，core 合约仅包含最基础的交易功能，核心代码仅 200 行左右，由于用户资金都存储在 core 合约中，因此需要保证 core 合约最简化，避免引入 bug；periphery">
<meta property="og:type" content="article">
<meta property="og:title" content="UniswapV2合约">
<meta property="og:url" content="https://q1ngying.cn/UniswapV2/index.html">
<meta property="og:site_name" content="Q1ngying">
<meta property="og:description" content="深入理解 Uniswap v2 合约代码来源：https:&#x2F;&#x2F;hackmd.io&#x2F;@adshao&#x2F;rk7nI-EG9 合约架构：Unsiwap-v2 合约主要分为两类：core 合约和 periphery 合约。其中 ，core 合约仅包含最基础的交易功能，核心代码仅 200 行左右，由于用户资金都存储在 core 合约中，因此需要保证 core 合约最简化，避免引入 bug；periphery">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://q1ngying.cn/img/butterfly-icon.jpg">
<meta property="article:published_time" content="2023-11-05T12:16:15.000Z">
<meta property="article:modified_time" content="2024-10-18T07:09:28.297Z">
<meta property="article:author" content="Q1ngying">
<meta property="article:tag" content="Solidity">
<meta property="article:tag" content="DeFi">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://q1ngying.cn/img/butterfly-icon.jpg"><link rel="shortcut icon" href="/img/icons8-clover-ios-16-glyph-32.png"><link rel="canonical" href="https://q1ngying.cn/UniswapV2/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><meta name="google-site-verification" content="IzCM4B791_p7IAU4WhRfiLlPBnODnamJ7ixKxzoeNfk"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#1b1b1b')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#FFFFFF')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"prismjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'UniswapV2合约',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-10-18 15:09:28'
}</script><script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script><script>LA.init({id:"3Jzfa21KlLms3Lkh",ck:"3Jzfa21KlLms3Lkh"})</script><link rel="stylesheet" href="/css/style.css?1"><!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/butterfly-icon.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">76</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">28</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">27</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><span> 友链</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/back1.webp);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Q1ngying</span></a><a class="nav-page-title" href="/"><span class="site-name">UniswapV2合约</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> 文章</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-user"></i><span> 关于</span></a></li><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><span> 友链</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">UniswapV2合约</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-11-05T12:16:15.000Z" title="发表于 2023-11-05 20:16:15">2023-11-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-10-18T07:09:28.297Z" title="更新于 2024-10-18 15:09:28">2024-10-18</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/learn/">learn</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Solidity/">Solidity</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/DeFi/">DeFi</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">122k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>6:45分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="深入理解-Uniswap-v2-合约代码"><a href="#深入理解-Uniswap-v2-合约代码" class="headerlink" title="深入理解 Uniswap v2 合约代码"></a>深入理解 Uniswap v2 合约代码</h1><p>来源：<a target="_blank" rel="noopener" href="https://hackmd.io/@adshao/rk7nI-EG9">https://hackmd.io/@adshao/rk7nI-EG9</a></p>
<h2 id="合约架构："><a href="#合约架构：" class="headerlink" title="合约架构："></a>合约架构：</h2><p><strong>Unsiwap-v2 合约主要分为两类：core 合约和 periphery 合约。</strong>其中 ，<strong>core 合约仅包含最基础的交易功能</strong>，核心代码仅 200 行左右，由于<strong>用户资金都存储在 core 合约中</strong>，因此<strong>需要保证 core 合约最简化，避免引入 bug</strong>；periphery 合约则针对用户使用场景提供多种封装方法，比如支持原生 ETH 交易（自动转为 WETH），多路径交换（一个方法同时执行 A-&gt; B -&gt; C 交易）等，其底层调用的是 core 合约，我们在<a target="_blank" rel="noopener" href="https://app.uniswap.org/">app.uniswap.org</a>界面操作时用的就是periphery合约。</p>
<p><img src="https://raw.githubusercontent.com/Q1ngYing/images/master/images/J9txqxI.png" alt="img"></p>
<p>首先介绍几个主要合约的功能：</p>
<ul>
<li>uniswap-v2-core<ul>
<li>UniswapV2Factory：工厂合约，用于创建 Pair 合约（以及设置协议手续费接收地址）</li>
<li>UniswapV2Pair：Pair（交易对）合约，定义和交易有关的几个最基础方法，如：swap/mint/burn，价格预言机等功能，其本身是一个 ERC20 合约，继承 UniswapV2ERC20</li>
<li>UniswapV2ERC20：实现 ERC20 标准方法</li>
</ul>
</li>
<li>uniswap-v2-periphery<ul>
<li>UniswapV2Router02：最新版的路由合约，相比 UniswapV2Rounter01 增加了对 FeeOnTransfer 代币的支持；实现 Uniswap-v2 最常用的接口，比如添加/移出流动性，使用代币 A 兑换代币 B，使用 ETH 交换代币等</li>
<li>UniswapV1Rount01：旧版本 Rounter 实现，与 Rounter02 类似，但不支持 FeeOnTransferTokens，目前已不使用</li>
</ul>
</li>
</ul>
<h2 id="Uniswap-v2-core"><a href="#Uniswap-v2-core" class="headerlink" title="Uniswap-v2-core"></a>Uniswap-v2-core</h2><p><a target="_blank" rel="noopener" href="https://github.com/Uniswap/v2-core">代码地址</a></p>
<h3 id="UniswapV2Factory"><a href="#UniswapV2Factory" class="headerlink" title="UniswapV2Factory"></a>UniswapV2Factory</h3><p>在工厂合约最重要的是 createPair 方法：</p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">function</span> <span class="token function">createPair</span><span class="token punctuation">(</span><span class="token builtin">address</span> tokenA<span class="token punctuation">,</span> <span class="token builtin">address</span> tokenB<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">address</span> pair<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>tokenA <span class="token operator">!=</span> tokenB<span class="token punctuation">,</span> <span class="token string">"UniswapV2: IDENTICAL_ADDRESS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span><span class="token builtin">address</span> token0<span class="token punctuation">,</span> <span class="token builtin">address</span> token1<span class="token punctuation">)</span> <span class="token operator">=</span> tokenA <span class="token operator">&lt;</span> tokenB <span class="token operator">?</span> <span class="token punctuation">(</span>tokenA<span class="token punctuation">,</span> tokenB<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>tokenB<span class="token punctuation">,</span> tokenA<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>token0 <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'UniswapV2: ZERO_ADDRESS'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>getPair<span class="token punctuation">[</span>token0<span class="token punctuation">]</span><span class="token punctuation">[</span>token1<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"UniswapV2: PAIR_EXISTS"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">bytes</span> <span class="token keyword">memory</span> bytecode <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>UniswapV2Pair<span class="token punctuation">)</span><span class="token punctuation">.</span>creationCode<span class="token punctuation">;</span>
	<span class="token builtin">bytes32</span> salt <span class="token operator">=</span> <span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>token0<span class="token punctuation">,</span> token1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">assembly</span> <span class="token punctuation">&#123;</span>
		pair <span class="token operator">:=</span> <span class="token function">create2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span>bytecode<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mload</span><span class="token punctuation">(</span>bytecode<span class="token punctuation">)</span><span class="token punctuation">,</span> salt<span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token function">IUniswapV2Pair</span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span>token0<span class="token punctuation">,</span> token1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	getPair<span class="token punctuation">[</span>token0<span class="token punctuation">]</span><span class="token punctuation">[</span>token1<span class="token punctuation">]</span> <span class="token operator">=</span> pair<span class="token punctuation">;</span>
	getPair<span class="token punctuation">[</span>token1<span class="token punctuation">]</span><span class="token punctuation">[</span>token0<span class="token punctuation">]</span> <span class="token operator">=</span> pair<span class="token punctuation">;</span> <span class="token comment">// populate mapping in the reverse direction</span>
	allPairs<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">emit</span> <span class="token function">PairCreated</span><span class="token punctuation">(</span>token0<span class="token punctuation">,</span> token1<span class="token punctuation">,</span> pair<span class="token punctuation">,</span> allPairs<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>首先将 token0 和 token1 按照顺序排序，确保 token0 字面地址小于 token1。接着使用 <code>assembly + create2</code> 创建合约。</strong><code>assembly</code>可以在 Solidity 中使用 Yul 语言直接操作 EVM，是较底层的操作方法。<strong>create2 主要用于创建确定性的交易对合约地址，目的是根据两个代币地址直接计算 pair 地址</strong>，而无需调用链上合约查询</p>
<p>根据 CREATE2 的 <a target="_blank" rel="noopener" href="https://eips.ethereum.org/EIPS/eip-1014">EIP-1014</a> 规范，在<strong>这里影响最终生成合约地址的是</strong>用户自定义的 <strong><code>salt</code></strong>。<strong>对于同一个交易对的两种代币，其 salt 值应该是一样的</strong>，<strong>通俗规定，通过交易对的两种代币的地址直接计算出 salt 值</strong>，而生成 <strong>salt 值又受到两种代币地址的先后顺序的影响</strong>，因此<strong>在合约开始时，先对两种代币进行排序，确保其按照从小到大的顺序生成 salt 值。</strong></p>
<p>在最新版的 EVM 中，已经支持给 new 方法传递 salt 参数：</p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity">pair <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UniswapV2Pair</span><span class="token punctuation">&#123;</span>sa<span class="token punctuation">;</span>t<span class="token punctuation">:</span> salt<span class="token punctuation">&#125;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>因为 Uniswap-v2 合约在开发时还没有这个功能，所以使用 assembly create2。</p>
<p>根据<a target="_blank" rel="noopener" href="https://docs.soliditylang.org/en/develop/yul.html#yul">Yul规范</a>，create2 的定义如下：</p>
<blockquote>
<p>create2(v, p, n, s)</p>
<p>create new contract with code mem[p…(p+n)) at address keccak256(0xff . this . s . keccak256(mem[p…(p+n))) and send v wei and return the new address, where 0xff is a 1 byte value, this is the current contract’s address as a 20 byte value and s is a big-endian 256-bit value; returns 0 on error</p>
</blockquote>
<p>源码中调用create2方法：</p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity">pair <span class="token operator">:=</span> <span class="token function">create2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">add</span><span class="token punctuation">(</span>bytecode<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mload</span><span class="token punctuation">(</span>bytecode<span class="token punctuation">)</span><span class="token punctuation">,</span> salt<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>因此，这几个参数含义如下：</p>
<ul>
<li><p>v=0：向新创建的pair合约中发送的ETH代币数量（单位wei）</p>
</li>
<li><p>p=add(bytecode, 32)：合约字节码的起始位置</p>
<blockquote>
<p>此处为什么要add 32呢？因为bytecode类型为bytes，根据ABI规范，bytes为变长类型，在编码时前32个字节存储bytecode的长度，接着才是bytecode的真正内容，因此合约字节码的起始位置在bytecode+32字节</p>
</blockquote>
</li>
<li><p>n=mload(bytecode)：合约字节码总字节长度</p>
<blockquote>
<p>根据上述说明，bytecode前32个字节存储合约字节码的真正长度（以字节为单位），而mload的作用正是读出传入参数的前32个字节的值，因此mload(bytecode)就等于n</p>
</blockquote>
</li>
<li><p>s=salt：s为自定义传入的salt，即token0和token1合并编码</p>
</li>
</ul>
<h3 id="UniswapV2ERC20"><a href="#UniswapV2ERC20" class="headerlink" title="UniswapV2ERC20"></a>UniswapV2ERC20</h3><p>这个合约主要定义了 UniswapV2 的 ERC20 标准实现，代码比较简单。下面介绍 <code>permit</code> 方法：</p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">function</span> <span class="token function">permit</span><span class="token punctuation">(</span><span class="token builtin">address</span> owner<span class="token punctuation">,</span> <span class="token builtin">address</span> spender<span class="token punctuation">,</span> <span class="token builtin">uint</span> value<span class="token punctuation">,</span> <span class="token builtin">uint</span> deadline<span class="token punctuation">,</span> <span class="token builtin">uint8</span> v<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> r<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> s<span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>deadline <span class="token operator">></span> block<span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span> <span class="token string">'UniswapV2: EXPIRED'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">bytes32</span> digest <span class="token operator">=</span> <span class="token function">keccak256</span><span class="token punctuation">(</span>
		abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
            <span class="token string">'\x19\x01'</span><span class="token punctuation">,</span>
            DOMAIN_SEPARATOR<span class="token punctuation">,</span>
            <span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>PERMIT_TYPEHASH<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> value<span class="token punctuation">,</span> nonces<span class="token punctuation">[</span>owner<span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">,</span> deadline<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">)</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">address</span> recoveredAddress <span class="token operator">=</span> <span class="token function">ecrecover</span><span class="token punctuation">(</span>digest<span class="token punctuation">,</span> v<span class="token punctuation">,</span> r<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>recoverAddress <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> recoveredAddress <span class="token operator">==</span> owner<span class="token punctuation">,</span> <span class="token string">'UniswapV2: INVALID_SIGNATURE'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">_approve</span><span class="token punctuation">(</span>owner<span class="token punctuation">,</span> spender<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>permit方法实现的就是白皮书2.5节中介绍的<strong>“Meta transactions for pool shares 元交易”</strong>功能。<a target="_blank" rel="noopener" href="https://eips.ethereum.org/EIPS/eip-712">EIP-712</a>定义了<strong>离线签名的规范</strong>，即digest的格式定义，用户签名的内容是其（owner）授权（approve）某个合约（spender）可以在截止时间（deadline）之前花掉一定数量（value）的代币（Pair流动性代币），应用（periphery合约）拿着签名的原始信息和签名后生成的v, r, s，可以调用Pair合约的permit方法获得授权，permit 方法使用 ecrecover 还原出签名地址为代币所有人，验证通过则批准授权。</p>
<h3 id="UniswapV2Pair"><a href="#UniswapV2Pair" class="headerlink" title="UniswapV2Pair"></a>UniswapV2Pair</h3><p>Pair 合约主要实现了三个方法：mint（添加流动性）、burn（移出流动性）、swap（兑换）。</p>
<h4 id="mint-实现添加流动性功能"><a href="#mint-实现添加流动性功能" class="headerlink" title="mint-实现添加流动性功能"></a><strong>mint-实现添加流动性功能</strong></h4><p>该方法实现添加流动性功能：</p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// this low-level function should be called from a contract which performs important safety checks</span>
<span class="token keyword">function</span> <span class="token function">mint</span><span class="token punctuation">(</span><span class="token builtin">address</span> to<span class="token punctuation">)</span> <span class="token keyword">external</span> lock <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> liquidity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">(</span><span class="token builtin">uint112</span> _reserve0<span class="token punctuation">,</span> <span class="token builtin">uint112</span> _reserve1<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">getReserves</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// gas savings </span>
	<span class="token builtin">uint</span> balance0 <span class="token operator">=</span> <span class="token function">IERC20</span><span class="token punctuation">(</span>token0<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">uint</span> balance1 <span class="token operator">=</span> <span class="token function">IERC20</span><span class="token punctuation">(</span>token1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">uint</span> amount0 <span class="token operator">=</span> balance0<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>_reserve0<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">uint</span> amount1 <span class="token operator">=</span> balance1<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>_reserve1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token builtin">bool</span> feeOn <span class="token operator">=</span> <span class="token function">_mintFee</span><span class="token punctuation">(</span>_reserve0<span class="token punctuation">,</span> _resverve1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 计算协议手续费</span>
	<span class="token builtin">uint</span> _totalSupply <span class="token operator">=</span> totalSupply<span class="token punctuation">;</span> <span class="token comment">// gas savings, must be define here since totalSupply can update in _mintFee</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>_totalSupply <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		liquidity <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>amount0<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>amount1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>MINIMUM_LIQUIDITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">_mint</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MINTMUM_LIQUIDITY<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// permanently lock the first MINIMUM_LIQUIDITY tokens</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		liquidity <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>amount0<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>_totalSupply<span class="token punctuation">)</span> <span class="token operator">/</span> _reserve0<span class="token punctuation">,</span> amount1<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>_totalSupply<span class="token punctuation">)</span> <span class="token operator">/</span> _reserve1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>liquidity <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'UniswapV2: INSUFFICIENT_LIQUIDITY_MINTED'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">_mint</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> liquidity<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">_update</span><span class="token punctuation">(</span>balance0<span class="token punctuation">,</span> balance1<span class="token punctuation">,</span> _reserve0<span class="token punctuation">,</span> _reserve1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>feeOn<span class="token punctuation">)</span> kLast <span class="token operator">=</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>reserve0<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>reserve1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// reserve0 and reserve1 are up-to-date</span>
	<span class="token keyword">emit</span> <span class="token function">Mint</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> amount0<span class="token punctuation">,</span> amount1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先，<code>getReserves()</code>获取两种代币的缓存余额（函数内第一行），在白皮书中提到，<strong>保存缓存余额是为了防止攻击者操控价格预言机</strong>。此处还用于计算协议手续费，并通过当前余额与缓存余额获取转账的代币数量。</p>
<h5 id="mintFee用于计算协议手续费："><a href="#mintFee用于计算协议手续费：" class="headerlink" title="_mintFee用于计算协议手续费："></a><code>_mintFee</code>用于计算协议手续费：</h5><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// if fee is on, mint liquidity equivalent to 1/6th of the growth in sqrt(k)</span>
<span class="token keyword">function</span> <span class="token function">_mintFee</span><span class="token punctuation">(</span><span class="token builtin">uint112</span> _reserve0<span class="token punctuation">,</span> <span class="token builtin">uint112</span> _reserve1<span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bool</span> feeOn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token builtin">address</span> feeTo <span class="token operator">=</span> <span class="token function">IUniswapV2Factory</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">feeTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    feeOn <span class="token operator">=</span> feeTo <span class="token operator">!=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">uint</span> _kLast <span class="token operator">=</span> kLast<span class="token punctuation">;</span> <span class="token comment">// gas savings</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>feeOn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_kLast <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token builtin">uint</span> rootK <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">(</span>_reserve0<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>_reserve1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token builtin">uint</span> rootKLast <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">sqrt</span><span class="token punctuation">(</span>_kLast<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>rootK <span class="token operator">></span> rootKLast<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token builtin">uint</span> numerator <span class="token operator">=</span> totalSupply<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>rootK<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>rootKLast<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token builtin">uint</span> denominator <span class="token operator">=</span> rootK<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rootKLast<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token builtin">uint</span> liquidity <span class="token operator">=</span> numerator <span class="token operator">/</span> denominator<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>liquidity <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">_mint</span><span class="token punctuation">(</span>feeTo<span class="token punctuation">,</span> liquidity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_kLast <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        kLast <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>关于协议手续费的计算公式可以参考白皮书。</p>
<p>mint 方法中判断，如果是首次提供该交易对的流动性，则根据根号 xy 生成流动性代币，并销毁其中的 MINIMUM_LIQUIDITY（即1000 wei ）；否则根据转入的代币价值与当前流动性价值比例铸造流动性代币。</p>
<h4 id="burn-实现移除流动性功能"><a href="#burn-实现移除流动性功能" class="headerlink" title="burn-实现移除流动性功能"></a><strong>burn-实现移除流动性功能</strong></h4><p>该方法实现移除流动性功能：</p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// this low-level function should be called from a contract which contract which performs important safety checks</span>
<span class="token keyword">function</span> <span class="token function">burn</span><span class="token punctuation">(</span><span class="token builtin">address</span> to<span class="token punctuation">)</span> <span class="token keyword">external</span> lock <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amount0<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount1<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">(</span><span class="token builtin">uint112</span> _reserve0<span class="token punctuation">,</span> <span class="token builtin">uint112</span> _reserve1<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">getReserves</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//gas savings</span>
	<span class="token builtin">address</span> _token0 <span class="token operator">=</span> token0<span class="token punctuation">;</span>
	<span class="token builtin">address</span> _token1 <span class="token operator">=</span> token1<span class="token punctuation">;</span>
	<span class="token builtin">uint</span> balance0 <span class="token operator">=</span> <span class="token function">IERC20</span><span class="token punctuation">(</span>_token0<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">uint</span> balance1 <span class="token operator">=</span> <span class="token function">IERC20</span><span class="token punctuation">(</span>_token1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">uint</span> liquidity <span class="token operator">=</span> balanceOf<span class="token punctuation">[</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	
	<span class="token builtin">bool</span> feeOn <span class="token operator">=</span> <span class="token function">_mintFee</span><span class="token punctuation">(</span>_reserve0<span class="token punctuation">,</span> _reserve1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">uint</span> _totalSupply <span class="token operator">=</span> totalSupply<span class="token punctuation">;</span> <span class="token comment">// gas savings, must be define here since totalSupply can uodate in _mintFee</span>
	amount0 <span class="token operator">=</span> liquidity<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>balance0<span class="token punctuation">)</span> <span class="token operator">/</span> _totalSupply<span class="token punctuation">;</span> <span class="token comment">// using balances ensure pro-rate distribution</span>
	amount1 <span class="token operator">=</span> liquidity<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>balance1<span class="token punctuation">)</span> <span class="token operator">/</span> _totalSupply<span class="token punctuation">;</span> <span class="token comment">// using balances ensure pro-rate distribution</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>amount0 <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> amount1 <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token string">'UniswapV2: INSUFFICIENT_LIQUIDITY_BURNED'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">_burn</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> liquidity<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">_safeTransfer</span><span class="token punctuation">(</span>_token0<span class="token punctuation">,</span> to<span class="token punctuation">,</span> amount0<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">_safeTransfer</span><span class="token punctuation">(</span>_token1<span class="token punctuation">,</span> to<span class="token punctuation">,</span> amount1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	balance0 <span class="token operator">=</span> <span class="token function">IERC20</span><span class="token punctuation">(</span>_token0<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	balance1 <span class="token operator">=</span> <span class="token function">IERC20</span><span class="token punctuation">(</span>_token1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token function">_update</span><span class="token punctuation">(</span>balance0<span class="token punctuation">,</span> balance1<span class="token punctuation">,</span> _reserve0<span class="token punctuation">,</span> _reserve1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>feeOn<span class="token punctuation">)</span> kLast <span class="token operator">=</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>reserve0<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>reserve1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// reserve0 and reserbe1 are up-to-date</span>
	<span class="token keyword">emit</span> <span class="token function">Burn</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> amount0<span class="token punctuation">,</span> amount1<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>与 mint 类似，burn 方法也会先计算协议手续费</p>
<p>参考白皮书，为了节省交易手续费，Uniswap v2 只在 mint/burn 流动性时收取累计的协议手续费。</p>
<p>移出流动性后，根据销毁的流动性代币占总量的比例获得对应的两种代币。</p>
<h4 id="swap-实现两种代币的交换（交易）功能"><a href="#swap-实现两种代币的交换（交易）功能" class="headerlink" title="swap-实现两种代币的交换（交易）功能"></a><strong>swap-实现两种代币的交换（交易）功能</strong></h4><p>该方法实现两种代币的交换（交易）功能。</p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// this low-level function should be called from a contract which performs important safety checks</span>
<span class="token keyword">function</span> <span class="token function">swap</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amount0Out<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount1Out<span class="token punctuation">,</span> <span class="token builtin">address</span> to<span class="token punctuation">,</span> <span class="token builtin">bytes</span> <span class="token keyword">calldata</span> data<span class="token punctuation">)</span> <span class="token keyword">external</span> lock <span class="token punctuation">&#123;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>amount0Out <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> amount1Out <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'UniswapV2: INSUFFICIENT_OUTPUT_AMOUNT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span><span class="token builtin">uint112</span> _reserve0<span class="token punctuation">,</span> <span class="token builtin">uint112</span> _reserve1<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">getReserves</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// gas savings</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>amount0Out <span class="token operator">&lt;</span> _reserve0 <span class="token operator">&amp;&amp;</span> amount1Out <span class="token operator">&lt;</span> _reserve1<span class="token punctuation">,</span> <span class="token string">'UnsiwapV2: INSUFFICIENT_LIQUIDITY'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token builtin">uint</span> balance0<span class="token punctuation">;</span>
	<span class="token builtin">uint</span> balance1<span class="token punctuation">;</span>
	<span class="token punctuation">&#123;</span> <span class="token comment">// scope for _token&#123;0, 1&#125;, avoids stack too deep errors</span>
	<span class="token builtin">address</span> _token0 <span class="token operator">=</span> token0<span class="token punctuation">;</span>
	<span class="token builtin">address</span> _token1 <span class="token operator">=</span> token1<span class="token punctuation">;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>to <span class="token operator">!=</span> _token0 <span class="token operator">&amp;&amp;</span> to <span class="token operator">!=</span> _token1<span class="token punctuation">,</span><span class="token string">'Uniswap: INVALID_TO'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>amount0Out <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">_safeTransfer</span><span class="token punctuation">(</span>_token0<span class="token punctuation">,</span> to<span class="token punctuation">,</span> amount0Out<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>amount1Out <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">_safeTransfer</span><span class="token punctuation">(</span>_token1<span class="token punctuation">,</span> to<span class="token punctuation">,</span> amount1Out<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>length <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">IUniswapV2Callee</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uniswapV2Call</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> amount0Out<span class="token punctuation">,</span> amount1Out<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	balance0 <span class="token operator">=</span> <span class="token function">IERC20</span><span class="token punctuation">(</span>_token0<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	balance1 <span class="token operator">=</span> <span class="token function">IERC20</span><span class="token punctuation">(</span>_token1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">balanceOf</span><span class="token punctuation">(</span><span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token builtin">uint</span> amount0In <span class="token operator">=</span> balance0 <span class="token operator">></span> _reserve0 <span class="token operator">-</span> amount0Out <span class="token operator">?</span> balance0 <span class="token operator">-</span> <span class="token punctuation">(</span>_reserve0 <span class="token operator">-</span> amount0Out<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token builtin">uint</span> amount1In <span class="token operator">=</span> balance1 <span class="token operator">></span> _reserve1 <span class="token operator">-</span> amount1Out <span class="token operator">?</span> balance1 <span class="token operator">-</span> <span class="token punctuation">(</span>_reserve1 <span class="token operator">-</span> amount1Out<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>amount0In <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">||</span> amount1In <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'UniswapV2: INSUFFICIENT_INPUT_AMOUNT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#123;</span> <span class="token comment">// scope for reserve&#123;0, 1&#125;Adjusted, avoids stacj too deep errors</span>
	<span class="token builtin">uint</span> balance0Adjusted <span class="token operator">=</span> balance0<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>amount0In<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">uint</span> balance1Adjusted <span class="token operator">=</span> balance1<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>amount0In<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>balance0Adjusted<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>balance1Adjusted<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>_reserve0<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>_reserve1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'UniswapV2: K'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	
	<span class="token function">_update</span><span class="token punctuation">(</span>balance0<span class="token punctuation">,</span> balance1<span class="token punctuation">,</span> _reserve0<span class="token punctuation">,</span> _reserve1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">emit</span> <span class="token function">Swap</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> amount0In<span class="token punctuation">,</span> amount1In<span class="token punctuation">,</span> amount0Out<span class="token punctuation">,</span> amount1Out<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了兼容闪电贷功能，以及不依赖特定代币的 transfer 方法，整个 swap 方法并没有类型 amountln 的参数，而是通过比较当前余额与缓存余额的差值来得出转入的代币数量。</p>
<p>由于在 swap 方法最后会检查余额（扣掉手续费后）符合 k 常量函数约束（参考白皮书公式），因此合约可以先将用户希望获得的代币转出，如果用户之前并没有向合约转入用于交易的代币，则相当于借币（即：<strong>闪电贷</strong>）；如果使用闪电贷，则需要在自定义的 uniswapV2Call 方法中将借出的代币归还。</p>
<p>在 swap 方法最后会使用缓存余额更新价格预言机所需的累计价格，最后更新缓存余额为当前余额。</p>
<h5 id="update更新缓存余额"><a href="#update更新缓存余额" class="headerlink" title="_update更新缓存余额"></a><code>_update</code>更新缓存余额</h5><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// update reserves and, on first call per block, price accumulators</span>
<span class="token keyword">function</span> <span class="token function">_update</span><span class="token punctuation">(</span><span class="token builtin">uint</span> balance0<span class="token punctuation">,</span> <span class="token builtin">uint</span> balance1<span class="token punctuation">,</span> <span class="token builtin">uint112</span> _reserve0<span class="token punctuation">,</span> <span class="token builtin">uint112</span> _reserve1<span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>balance0 <span class="token operator">&lt;=</span> <span class="token builtin">uint112</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> balance1 <span class="token operator">&lt;=</span> <span class="token builtin">uint112</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'UniswapV2: OVERFLOW'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">uint32</span> blockTimestamp <span class="token operator">=</span> <span class="token builtin">uint32</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>timestamp <span class="token operator">%</span> <span class="token number">2</span><span class="token operator">**</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">uint32</span> timeElapsed <span class="token operator">=</span> blockTimestamp <span class="token operator">-</span> blockTimestampLast<span class="token punctuation">;</span> <span class="token comment">// overflow is desired</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>timeElapsed <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> reserve0 <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> _reserve1 <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	price0CumulativeLast <span class="token operator">+=</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>UQ112x112<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>_reserve1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uqdiv</span><span class="token punctuation">(</span>_reserve0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> timeElapsed<span class="token punctuation">;</span>
	price1CumulativeLast <span class="token operator">+=</span> <span class="token builtin">uint</span><span class="token punctuation">(</span>UQ112x112<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>_reserve0<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uqdiv</span><span class="token punctuation">(</span>_reserve1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> timeElapsed<span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	reserve0 <span class="token operator">=</span> <span class="token builtin">uint112</span><span class="token punctuation">(</span>balance0<span class="token punctuation">)</span><span class="token punctuation">;</span>
	reserve1 <span class="token operator">=</span> <span class="token builtin">uint112</span><span class="token punctuation">(</span>balance1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	blockTimestampLast <span class="token operator">=</span> blockTimestamp<span class="token punctuation">;</span>
	<span class="token keyword">emit</span> <span class="token function">Sync</span><span class="token punctuation">(</span>reserve0<span class="token punctuation">,</span> reserve1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主要，其中区块时间戳和累计价格都是溢出安全的。（具体推导过程参考白皮书）</p>
<h2 id="UniswapV2Router02"><a href="#UniswapV2Router02" class="headerlink" title="UniswapV2Router02"></a>UniswapV2Router02</h2><p>Router02 封装了最常用的几个交易接口；为了满足原生 ETH 交易需求，大部分接口都支持 ETH 版本；同，相比 Router01，部分接口增加了 FeeOnTransferTokens 的支持。</p>
<p><img src="https://raw.githubusercontent.com/Q1ngYing/images/master/images/vw84rOW.png" alt="img"></p>
<p>接下来主要研究 ERC20 版本的代码，因为 ETH 版本只是将 ETH 和 WETH 做转换，逻辑与 ERC20 一致。</p>
<p>首先先了解 Library 合约中的几个常用方法，以及它们的数学公式推导。</p>
<h3 id="Library"><a href="#Library" class="headerlink" title="Library"></a>Library</h3><p><a target="_blank" rel="noopener" href="https://github.com/Uniswap/v2-periphery/blob/master/contracts/libraries/UniswapV2Library.sol">代码地址</a></p>
<h4 id="pairFor-计算两个代币的交易对地址"><a href="#pairFor-计算两个代币的交易对地址" class="headerlink" title="pairFor-计算两个代币的交易对地址"></a>pairFor-计算两个代币的交易对地址</h4><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// calculates the CREATE2 address for a pair without making any external calls</span>
<span class="token keyword">function</span> <span class="token function">pairFor</span><span class="token punctuation">(</span><span class="token builtin">address</span> factory<span class="token punctuation">,</span> <span class="token builtin">address</span> tokenA<span class="token punctuation">,</span> <span class="token builtin">address</span> tokenB<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">address</span> pair<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">(</span><span class="token builtin">address</span> token0<span class="token punctuation">,</span> <span class="token builtin">address</span> token1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">sortTokens</span><span class="token punctuation">(</span>tokenA<span class="token punctuation">,</span> tokenB<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pair <span class="token operator">=</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">(</span><span class="token function">keccak</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>
		hex<span class="token string">'ff'</span><span class="token punctuation">,</span>
		factory<span class="token punctuation">,</span>
		<span class="token function">keccak256</span><span class="token punctuation">(</span>abi<span class="token punctuation">.</span><span class="token function">encodePacked</span><span class="token punctuation">(</span>token0<span class="token punctuation">,</span> token1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		hex<span class="token string">'96e8ac4277198ff8b6f785478aa9a39f403cb768dd02cbee326c3e7da348845f'</span> <span class="token comment">// init code hash</span>
	<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上文提到，由于使用 CREATE2 操作码，交易对地址可以直接根据规范算出，而无需调用链上合约进行查询。</p>
<blockquote>
<p>create2(v, p, n, s)</p>
<p>create new contract with code mem[p…(p+n)) at address keccak256(0xff . this . s . keccak256(mem[p…(p+n))) and send v wei and return the new address, where 0xff is a 1 byte value, this is the current contract’s address as a 20 byte value and s is a big-endian 256-bit value; returns 0 on error</p>
</blockquote>
<p>其中，新创建的 pair 合约的地址计算方法为：<code>keccak256(0xff + this + salt + keccak256(mem[p…(p+n)))</code>：</p>
<ul>
<li>this：工厂合约地址</li>
<li>salt：<code>keccak256(abi,encodePacked(token0, token1))</code></li>
<li><p>keccak256(mem[p…(p+n))： 0x96e8ac4277198ff8b6f785478aa9a39f403cb768dd02cbee326c3e7da348845f</p>
<p>由于每个交易对都使用 UniswapV2Pair 合约创建，init code hash 都是一样的。我们可以在 UniswapV2Factory 写一个 Solidity 方法计算 hash：</p>
</li>
</ul>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">function</span> <span class="token function">initCodeHash</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">external</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">bytes32</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token builtin">bytes</span> <span class="token keyword">memory</span> bytecode <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>UniswapV2Pair<span class="token punctuation">)</span><span class="token punctuation">.</span>creationCode<span class="token punctuation">;</span>
	<span class="token builtin">bytes32</span> hash<span class="token punctuation">;</span>
	<span class="token keyword">assembly</span> <span class="token punctuation">&#123;</span>
		hash <span class="token operator">:=</span> <span class="token function">keccak256</span><span class="token punctuation">(</span><span class="token function">add</span><span class="token punctuation">(</span>bytecode<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mload</span><span class="token punctuation">(</span>bytecode<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">&#125;</span>
	<span class="token keyword">return</span> hash<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="quote-两个代币之间计价单位转换"><a href="#quote-两个代币之间计价单位转换" class="headerlink" title="quote-两个代币之间计价单位转换"></a>quote-两个代币之间计价单位转换</h4><p>quote 方法将数量为 amountA 的代币 A，按照合约中两种代币余额比例，换算成另一个代币 B。此时不考虑手续费，因为仅是计价单位的换算。</p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// given some amount of an asset and pair reserves, returns an equivalent amount of the other asset</span>
<span class="token keyword">function</span> <span class="token function">quote</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amountA<span class="token punctuation">,</span> <span class="token builtin">uint</span> reserveA<span class="token punctuation">,</span> <span class="token builtin">uint</span> reserveB<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> amountB<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>amountA <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'UniswapV2Library: INSUFFICIENT_AMOUNT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>reserveA <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> reserveB <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'UniswapV2Library: INSUFFICIENT_LIQUDITY'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	amountB <span class="token operator">=</span> amountA<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>reserveB<span class="token punctuation">)</span> <span class="token operator">/</span> reserveA<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="getAmountOut"><a href="#getAmountOut" class="headerlink" title="getAmountOut"></a>getAmountOut</h4><p>该方法计算：输入一定数量（amountIn）代币 A，根据池子中代币余额，能得到多少数量（amountOut）代币B。</p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// give an input amount an asset and pair reserves, returns the maximum output amout of the other asset</span>
<span class="token keyword">function</span> <span class="token function">getAmountOut</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amountIn<span class="token punctuation">,</span> <span class="token builtin">uint</span> reserveIn<span class="token punctuation">,</span> <span class="token builtin">uint</span> reserveOut<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> amountOut<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>amountIn <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'UniswapV2Library: INSUFFICIENT_INPUT_AMOUNT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>reserveIn <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> reserveOut <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'UniswapV2Library: INSUFFICIENT_LIQUIDITY'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">uint</span> amountInWithFee <span class="token operator">=</span> amountIn<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">997</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">uint</span> numerator <span class="token operator">=</span> amountInWithFee<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>reserveOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">uint</span> denominator <span class="token operator">=</span> reserveIn<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>amountInWithFee<span class="token punctuation">)</span><span class="token punctuation">;</span>
	amountOut <span class="token operator">=</span> numerator <span class="token operator">/</span> denominator<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该方法的数学公式如下：</p>
<p><img src="../images/UniswapV2合约/image-20231101170847732.png" alt="image-20231101170847732"></p>
<h4 id="getAmountIn"><a href="#getAmountIn" class="headerlink" title="getAmountIn"></a>getAmountIn</h4><p>该方法计算当希望获得一定数量（amountOut）的代币 B 是，应该输入多少数量（amountIn）的代币 A。</p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// given an output amount of an asset and pair reserves, returns a require input amount of the other asset</span>
<span class="token keyword">function</span> <span class="token function">getAmountIn</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amountOut<span class="token punctuation">,</span> <span class="token builtin">uint</span> reserveIn<span class="token punctuation">,</span> <span class="token builtin">uint</span> reserveOut<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">pure</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> amountIn<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>amountOut <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'UniswapV2Library: INSUFFICIENT_OUTPUT_AMOUNT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>reserveIn <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> reserveOut <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'UniswapV2Library: INSUFFICIENT_LIQUIDITY'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">uint</span> numerator <span class="token operator">=</span> reserveIn<span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span>amountOut<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">uint</span> denominator <span class="token operator">=</span> reserveOut<span class="token punctuation">.</span><span class="token function">sub</span><span class="token punctuation">(</span>amountOut<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mul</span><span class="token punctuation">(</span><span class="token number">997</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	amountIn <span class="token operator">=</span> <span class="token punctuation">(</span>numerator <span class="token operator">/</span> denominator<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><img src="../images/UniswapV2合约/image-20231101171606197.png" alt="image-20231101171606197"></p>
<p>计算结果即为合约中代码所示，注意最后有一个<code>add(1)</code>，这是为了防止 amountIn 为小鼠的情况，加 1 可以保证输入的数（amountIn）不小于理论的最小值。</p>
<h4 id="getAmountsOut"><a href="#getAmountsOut" class="headerlink" title="getAmountsOut"></a>getAmountsOut</h4><p>该方法用于计算在使用多个交易对时，输入一定数量（amountIn）的第一种代币，最终能收到多少数量的最后一种代币（amounts）。amounts 数组中的第一个元素表示 amountIn，最后一个元素表示该目标代币对应的数量。该方法实际上时循环调用 getAmountIn 方法。</p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// performs chained getAmountOut calculations on any number of pairs</span>
<span class="token keyword">function</span> <span class="token function">getAmountsOut</span><span class="token punctuation">(</span><span class="token builtin">address</span> factory<span class="token punctuation">,</span> <span class="token builtin">uint</span> amountIn<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> path<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> amounts<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'UniswapV2Library: INVALID_PATH'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	amounts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">uint</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
	amounts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> amountIn<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> i<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token punctuation">(</span><span class="token builtin">uint</span> reserveIn<span class="token punctuation">,</span> <span class="token builtin">uint</span> reserveOut<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">getReserves</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> path<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		amounts<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getAmountOut</span><span class="token punctuation">(</span>amounts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> reserveIn<span class="token punctuation">,</span> reserveOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="getAmountsIn"><a href="#getAmountsIn" class="headerlink" title="getAmountsIn"></a>getAmountsIn</h4><p>与 getAmountsOut 相对，getAmountsIn 用于计算当希望收到一定数量（amountOut）的目标代笔，应该分别输入多少数量的中间代币。计算方法也是循环调用 getAmountIn。</p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// performs chained getAmountIn calculations on any number of paids</span>
<span class="token keyword">function</span> <span class="token function">getAmountsIn</span><span class="token punctuation">(</span><span class="token builtin">address</span> factory<span class="token punctuation">,</span> <span class="token builtin">uint</span> amountOut<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> path<span class="token punctuation">)</span> <span class="token keyword">internal</span> <span class="token keyword">view</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> amounts<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>length <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'UniswapV2Library: INVALID_PATH'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	amounts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">uint</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
	amounts<span class="token punctuation">[</span>amounts<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> amountOut<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token builtin">uint</span> i <span class="token operator">=</span> path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">(</span><span class="token builtin">uint</span> reserveIn<span class="token punctuation">,</span> <span class="token builtin">uint</span> reserveOut<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">getReserves</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> path<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	amounts<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getAmountIn</span><span class="token punctuation">(</span>amounts<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> reserveIn<span class="token punctuation">,</span> reserveOut<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="ERC20-ERC20"><a href="#ERC20-ERC20" class="headerlink" title="ERC20-ERC20"></a>ERC20-ERC20</h3><h4 id="addLiquidity-添加流动性"><a href="#addLiquidity-添加流动性" class="headerlink" title="addLiquidity 添加流动性"></a>addLiquidity 添加流动性</h4><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">function</span> <span class="token function">addLiquidity</span><span class="token punctuation">(</span>
	<span class="token builtin">address</span> tokenA<span class="token punctuation">,</span>
	<span class="token builtin">address</span> tokenB<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> amountADesired<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> amountBDesired<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> amountAMin<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> amountBMin<span class="token punctuation">,</span>
	<span class="token builtin">address</span> to<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> deadline
<span class="token punctuation">)</span> <span class="token keyword">external</span> virtual override <span class="token function">ensure</span><span class="token punctuation">(</span>deadline<span class="token punctuation">)</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amountA<span class="token punctuation">,</span> <span class="token builtin">uint</span> amountB<span class="token punctuation">,</span> <span class="token builtin">uint</span> liquidity<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token punctuation">(</span>amountA<span class="token punctuation">,</span> amountB<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">_addLiquidity</span><span class="token punctuation">(</span>tokenA<span class="token punctuation">,</span> tokenB<span class="token punctuation">,</span> amountADesired<span class="token punctuation">,</span> amountBDesired<span class="token punctuation">,</span> amountAMin<span class="token punctuation">,</span> amountBMin<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">address</span> pair <span class="token operator">=</span> UniswapV2Library<span class="token punctuation">.</span><span class="token function">pariFor</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> tokenA<span class="token punctuation">,</span> tokenB<span class="token punctuation">)</span><span class="token punctuation">;</span>
	TransferHelper<span class="token punctuation">.</span><span class="token function">safeTransferFrom</span><span class="token punctuation">(</span>tokenA<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> pair<span class="token punctuation">,</span> amountA<span class="token punctuation">)</span><span class="token punctuation">;</span>
	TransferHelper<span class="token punctuation">.</span><span class="token function">safeTransferFrom</span><span class="token punctuation">(</span>tokenB<span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> pair<span class="token punctuation">,</span> amountB<span class="token punctuation">)</span><span class="token punctuation">;</span>
	liquidity <span class="token operator">=</span> <span class="token function">IUniswapV2Pair</span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mint</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>由于Router02是直接与用户交互的，因此接口设计需要从用户使用场景考虑。addLiquidity提供了8个参数：</p>
<ul>
<li>address tokenA：代币A</li>
<li>address tokenB：代币B</li>
<li>uint amountADesired：希望存入的代币A数量</li>
<li>uint amountBDesired：希望存入的代币B数量</li>
<li>uint amountAMin：最少存入的代币A数量</li>
<li>uint amountBMin：最少存入的代币B数量</li>
<li>address to：流动性代币接收地址</li>
<li>uint deadline：请求失效时间</li>
</ul>
<p>用户提交交易后，该交易被矿工打包的时间是不确定的，因此提交时的代币价格与交易打包时的价格可能不同，通过amountMin可以控制价格的浮动范围，防止被矿工或机器人套利；同样，deadline可以确保该交易在超过指定时间后将失效。</p>
<p>在 core 合约中提到，如果用户提供流动性时的代币价格与实际价格有差距，则只会按照较低的汇率得到流动性代币，多余的代币将贡献给整个池子。<strong><code>_addLiquidity</code>可以帮组计算最佳汇率</strong>。如果是<strong>首次添加流动性，则会创建交易对合约</strong>；<strong>否则根据当前池子余额计算</strong>应该注入的最佳代币数量。</p>
<h5 id="addLiquidity计算最佳汇率"><a href="#addLiquidity计算最佳汇率" class="headerlink" title="_addLiquidity计算最佳汇率"></a><code>_addLiquidity</code>计算最佳汇率</h5><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// **** ADD LIQUIDITY ****</span>
<span class="token keyword">function</span> <span class="token function">_addLiquidity</span><span class="token punctuation">(</span>
	<span class="token builtin">address</span> tokenA<span class="token punctuation">,</span>
	<span class="token builtin">address</span> tokenB<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> amountADesired<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> amountBDesired<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> amountAMin<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> amountBmin
<span class="token punctuation">)</span> <span class="token keyword">internal</span> virtual <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> amountA<span class="token punctuation">,</span> <span class="token builtin">uint</span> amountB<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token comment">// create the pair if it doesn't exist yet</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IUniswapV2Factory</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPair</span><span class="token punctuation">(</span>tokenA<span class="token punctuation">,</span> tokenB<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token function">IUniswapV2Factory</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createPair</span><span class="token punctuation">(</span>tokenA<span class="token punctuation">,</span> tokenB<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
	<span class="token punctuation">(</span><span class="token builtin">uint</span> reserveA<span class="token punctuation">,</span> <span class="token builtin">uint</span> reserveB<span class="token punctuation">)</span> <span class="token operator">=</span> UniswapV2Library<span class="token punctuation">.</span><span class="token function">getReserves</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> tokenA<span class="token punctuation">,</span> tokenB<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>reserveA <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> reserveB <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token punctuation">(</span>amountA<span class="token punctuation">,</span> amountB<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>amountADesired<span class="token punctuation">,</span> amountBDesired<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
		<span class="token builtin">uint</span> amountBOptimal <span class="token operator">=</span> UniswapV2Library<span class="token punctuation">.</span><span class="token function">getReserves</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> tokenA<span class="token punctuation">,</span> tokenB<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>amountBOptimal <span class="token operator">&lt;=</span> amountBDesired<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
			<span class="token keyword">require</span><span class="token punctuation">(</span>amountBOptimal <span class="token operator">>=</span> amountBMin<span class="token punctuation">,</span> <span class="token string">'UniswapV2Router: INSUFFICIENT_B_AMOUNT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">(</span>amountA<span class="token punctuation">,</span> amountB<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>amountADesired<span class="token punctuation">,</span> amountBOptimal<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
			<span class="token builtin">uint</span> amountBOptimal <span class="token operator">=</span> UniswapV2Library<span class="token punctuation">.</span><span class="token function">quote</span><span class="token punctuation">(</span>amountBDesired<span class="token punctuation">,</span> reserveB<span class="token punctuation">,</span> reserveA<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">assert</span><span class="token punctuation">(</span>amountAOptimal <span class="token operator">&lt;=</span> amountDesired<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">require</span><span class="token punctuation">(</span>amountA<span class="token punctuation">,</span> amountB<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>amountAOptimal<span class="token punctuation">,</span> amountBDesired<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">&#125;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后调用 core 合约 mint 方法铸造流动性代币。</p>
<h4 id="removeLiquidity-移出流动性"><a href="#removeLiquidity-移出流动性" class="headerlink" title="removeLiquidity 移出流动性"></a>removeLiquidity 移出流动性</h4><p>首先将流动性代币发送到 pair 合约，根据收到的流动性代币占全部代币比例，计算该流动性代币的两种代币数量。合约销毁流动性代币后，用户将受到对应比例的代币。如果低于用户的设定的最低预期（amountAMin/amountBMin），则回滚交易。</p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// **** REMOVE LIQUIDITY ****</span>
<span class="token keyword">function</span> <span class="token function">removeLiquidity</span><span class="token punctuation">(</span>
	<span class="token builtin">address</span> tokenA<span class="token punctuation">,</span>
	<span class="token builtin">address</span> tokenB<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> liquidity<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> amountAMin<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> amountBMin<span class="token punctuation">,</span>
	<span class="token builtin">address</span> to<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> deadline
<span class="token punctuation">)</span> <span class="token keyword">public</span> virtual override <span class="token function">ensure</span><span class="token punctuation">(</span>deadline<span class="token punctuation">)</span> <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amountA<span class="token punctuation">,</span> <span class="token builtin">uint</span> amountB<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token builtin">address</span> pair <span class="token operator">=</span> UniswapV2Library<span class="token punctuation">.</span><span class="token function">pairFor</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> tokenA<span class="token punctuation">,</span> tokenB<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">IUniswapV2Pair</span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transderFrom</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> pair<span class="token punctuation">,</span> liquidity<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// send liquidity to pair</span>
	<span class="token punctuation">(</span><span class="token builtin">uint</span> amount0<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount1<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">IUniswapV2Pair</span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">burn</span><span class="token punctuation">(</span>to<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span><span class="token builtin">address</span> token0<span class="token punctuation">,</span> <span class="token punctuation">)</span> <span class="token operator">=</span> UniswapV2Library<span class="token punctuation">.</span><span class="token function">sortTokens</span><span class="token punctuation">(</span>tokenA<span class="token punctuation">,</span> tokenB<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span>amountA<span class="token punctuation">,</span> amountB<span class="token punctuation">)</span> <span class="token operator">=</span> tokenA <span class="token operator">==</span> token0 <span class="token operator">?</span> <span class="token punctuation">(</span>amount0<span class="token punctuation">,</span> amount1<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>amount1<span class="token punctuation">,</span> amount0<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>amountA <span class="token operator">>=</span> amountAMin<span class="token punctuation">,</span> <span class="token string">'UniswapV2Router: INSUFFICIENT_A_AMOUNT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>amountB <span class="token operator">>=</span> amountBMin<span class="token punctuation">,</span> <span class="token string">'UniswapV2Router: INSUFFICIENT_B_AMOUNT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="removeLiquidityWithPermit-使用签名移除流动性"><a href="#removeLiquidityWithPermit-使用签名移除流动性" class="headerlink" title="removeLiquidityWithPermit 使用签名移除流动性"></a>removeLiquidityWithPermit 使用签名移除流动性</h4><p>用户正常移除流动性时，需要两个操作：</p>
<ul>
<li>approve：授权 Router 合约花费自己的流动性代币</li>
<li>removeLiquidity：调用 Router 合约移除流动性</li>
</ul>
<p>除非第一次授权了最大限额的代币，否则每次移除流动性都需要两次交互，这意味着用户需要支付两次手续费。而<strong>使用 removeLiquidityWithPermit 方法，用户可以通过签名方式授权 Router 合约花费自己的代币</strong>，无需单独调用 approve ，<strong>只需要调用一次移除流动性方法即可完成操作</strong>，节省了 gas 费用。同时，由于<strong>离线签名不需要花费 gas，因此可以每次签名仅授权一定额度的代币，提高安全性</strong>。</p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">function</span> <span class="token function">removeLiquidityWithPermit</span><span class="token punctuation">(</span>
	<span class="token builtin">address</span> tokenA<span class="token punctuation">,</span>
	<span class="token builtin">address</span> tokenB<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> liquidity<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> amountAMin<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> amountBMin<span class="token punctuation">,</span>
	<span class="token builtin">address</span> to<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> deadline<span class="token punctuation">,</span>
	<span class="token builtin">bool</span> approveMax<span class="token punctuation">,</span> <span class="token builtin">uint8</span> v<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> r<span class="token punctuation">,</span> <span class="token builtin">bytes32</span> s
<span class="token punctuation">)</span> <span class="token keyword">external</span> virtual override <span class="token keyword">returns</span><span class="token punctuation">(</span><span class="token builtin">uint</span> amountA<span class="token punctuation">,</span> <span class="token builtin">uint</span> amountB<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	<span class="token builtin">address</span> pair <span class="token operator">=</span> UniswapV2Library<span class="token punctuation">.</span><span class="token function">pairFor</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> tokenA<span class="token punctuation">,</span> tokenB<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token builtin">uint</span> value <span class="token operator">=</span> approveMax <span class="token operator">?</span> <span class="token builtin">uint</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> liquidity<span class="token punctuation">;</span>
	<span class="token function">IUniswapV2Pair</span><span class="token punctuation">(</span>pair<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permit</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> deadline<span class="token punctuation">,</span> v<span class="token punctuation">,</span> r<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span>amountA<span class="token punctuation">,</span> amountB<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">removeLiquidity</span><span class="token punctuation">(</span>tokenA<span class="token punctuation">,</span> tokenB<span class="token punctuation">,</span> liquidiry<span class="token punctuation">,</span> amountAMin<span class="token punctuation">,</span> amountBMin<span class="token punctuation">,</span> to<span class="token punctuation">,</span> deadline<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="swapExactTokensForTokens-根据指定的输入代币，获得最多的输出代币"><a href="#swapExactTokensForTokens-根据指定的输入代币，获得最多的输出代币" class="headerlink" title="swapExactTokensForTokens-根据指定的输入代币，获得最多的输出代币"></a>swapExactTokensForTokens-根据指定的输入代币，获得最多的输出代币</h4><p>交易时的两个常见场景：</p>
<ol>
<li>使用指定数量的代币 A（输入），尽可能兑换最多数量的代币 B （输出）</li>
<li>获得指定数量的代币 B（输出），尽可能使用最少数量的代币 A （输入）</li>
</ol>
<p>本方法实现了第一个场景，即根据指定的输入代币，获得最多的输出代币</p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">function</span> <span class="token function">sawpExactTokensForTokens</span><span class="token punctuation">(</span>
	<span class="token builtin">uint</span> amountIn<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> amountOutMin<span class="token punctuation">,</span>
	<span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">calldata</span> path<span class="token punctuation">,</span>
	<span class="token builtin">address</span> to<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> deadline
<span class="token punctuation">)</span> <span class="token keyword">external</span> virtual override <span class="token function">ensure</span><span class="token punctuation">(</span>deadline<span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> amounts<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	amounts <span class="token operator">=</span> UniswapV2Library<span class="token punctuation">.</span><span class="token function">getAmountsOut</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> amountIn<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>amounts<span class="token punctuation">[</span>amounts<span class="token punctuation">.</span>length <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">>=</span> amountOutMin<span class="token punctuation">,</span> <span class="token string">'UniswapV2Router: INSUFFICIENT_OUTPUT_AMOUNT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	TransferHelper<span class="token punctuation">.</span><span class="token function">safeTransferFrom</span><span class="token punctuation">(</span>
		path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> <span class="token function">UniswapV2Library</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> path<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> amounts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">_swap</span><span class="token punctuation">(</span>amounts<span class="token punctuation">,</span> path<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先<strong>使用 Library 合约中的 getAmountsOut 方法，根据兑换路径计算每一次交易的输出代币数量</strong>，<strong>确认</strong>最后一次交易得到的数量<code>(amounts[amounts.length - 1])</code> <strong>不小于预期最少输出</strong><code>(amountOutMin)</code>；<strong>将代币发送到第一个交易对地址，开始执行整个兑换交易。</strong></p>
<p>假设用户希望使用 WETH 兑换 DYDX，链下计算的最佳兑换路径为 WETH -&gt; USDC -&gt; DYDX，则 amountIn 为 WETH 数量，amountOutMin 为希望获得最少 DYDX 数量， path 为 <code>[WETH address, USDC address, DYDX address]</code>，amounts 为<code>[amountIn, USDC amount, DYDX amount]</code>。在 _swap 执行交易的过程中，每次中间交易获得的中间代币将被发送到下一个交易对地址，以此类推，直到最后一个交易完成，_to地址将收到最后一次交易的输入代币。</p>
<h5 id="swap"><a href="#swap" class="headerlink" title="_swap"></a>_swap</h5><pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token comment">// requires the initial amount to have already been sent to the first pair</span>
<span class="token keyword">function</span> <span class="token function">_swap</span><span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> amounts<span class="token punctuation">,</span> <span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> path<span class="token punctuation">,</span> <span class="token builtin">address</span> _to<span class="token punctuation">)</span> <span class="token keyword">internal</span> virtual <span class="token punctuation">&#123;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token builtin">uint</span> o<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
		<span class="token punctuation">(</span><span class="token builtin">address</span> input<span class="token punctuation">,</span> <span class="token builtin">address</span> output<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> path<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">(</span><span class="token builtin">address</span> token0<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> UniswapV2Library<span class="token punctuation">.</span><span class="token function">sortRokens</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">uint</span> amountOut <span class="token operator">=</span> amounts<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">(</span><span class="token builtin">uint</span> amount0Out<span class="token punctuation">,</span> <span class="token builtin">uint</span> amount1Out<span class="token punctuation">)</span> <span class="token operator">=</span> input <span class="token operator">==</span> token0 <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> amountOut<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span>amountOut<span class="token punctuation">,</span> <span class="token builtin">uint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token builtin">address</span> to <span class="token operator">=</span> i <span class="token operator">&lt;</span> path<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">?</span> UniswapV2Library<span class="token punctuation">.</span><span class="token function">pairFor</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> output<span class="token punctuation">,</span> path<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> _to<span class="token punctuation">;</span>
		<span class="token function">IUniswapV2Pair</span><span class="token punctuation">(</span>UniswapV2Library<span class="token punctuation">.</span><span class="token function">pairFor</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> input<span class="token punctuation">,</span> output<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>
			amount0Out<span class="token punctuation">,</span> amount1Out<span class="token punctuation">,</span> to<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">bytes</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="swapTokensForExactTokens-根据指定的输入代币使用最少的输入代币完成兑换"><a href="#swapTokensForExactTokens-根据指定的输入代币使用最少的输入代币完成兑换" class="headerlink" title="swapTokensForExactTokens-根据指定的输入代币使用最少的输入代币完成兑换"></a>swapTokensForExactTokens-根据指定的输入代币使用最少的输入代币完成兑换</h4><p>该方法实现交易的第二个场景，根据指定的输入代币，使用最少的输入代币完成兑换。</p>
<pre class="line-numbers language-solidity" data-language="solidity"><code class="language-solidity"><span class="token keyword">function</span> <span class="token function">swapTokensForExactTokens</span><span class="token punctuation">(</span>
	<span class="token builtin">uint</span> amountOut<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> amountInMax<span class="token punctuation">,</span>
	<span class="token builtin">address</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">calldata</span> path<span class="token punctuation">,</span>
	<span class="token builtin">address</span> to<span class="token punctuation">,</span>
	<span class="token builtin">uint</span> deadline
<span class="token punctuation">)</span> <span class="token keyword">external</span> virtual override <span class="token function">ensure</span><span class="token punctuation">(</span>deadline<span class="token punctuation">)</span> <span class="token keyword">returns</span> <span class="token punctuation">(</span><span class="token builtin">uint</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token keyword">memory</span> amounts<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
	amounts <span class="token operator">=</span> UniswapV2Library<span class="token punctuation">.</span><span class="token function">getAmountsIn</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> amountOut<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">require</span><span class="token punctuation">(</span>amounts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> amountInMax<span class="token punctuation">,</span> <span class="token string">'UniswapV2Router: EXCESSIVE_INPUT_AMOUNT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	TransferHelper<span class="token punctuation">.</span><span class="token function">safeTransferFrom</span><span class="token punctuation">(</span>
		path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> msg<span class="token punctuation">.</span>sender<span class="token punctuation">,</span> UniswapV2Library<span class="token punctuation">.</span><span class="token function">pairFor</span><span class="token punctuation">(</span>factory<span class="token punctuation">,</span> path<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> path<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> amounts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">_swap</span><span class="token punctuation">(</span>amounts<span class="token punctuation">,</span> path<span class="token punctuation">,</span> to<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>与上面类似，这里先使用Library的getAmountsIn方法反向计算每一次兑换所需的最少输入代币数量，确认计算得出的（扣除手续费后）第一个代币所需的最少代币数不大于用户愿意提供的最大代币数（amountInMax）；将代币发送到第一个交易对地址，调用_swap开始执行整个兑换交易。</p>
<h3 id="ERC20-ETH"><a href="#ERC20-ETH" class="headerlink" title="ERC20_ETH"></a>ERC20_ETH</h3><h4 id="ETH-Support"><a href="#ETH-Support" class="headerlink" title="ETH Support"></a>ETH Support</h4><p>由于 core 合约只支持 ERC20 代币支付，为了支持 ETH 交易，periphery 合约需要将 ETH 与 WETH 做转换；并为大部分方法提供了 ETH 版本，兑换主要这几两种操作：</p>
<ul>
<li><strong>地址转换</strong>：由于 ETH 没有合约地址，因此需要使用 WETH 合约的 deposit 和 withdraw 方法完成 ETH 和 WETH 的兑换</li>
<li><strong>代币数量转换：</strong>ETH代币需要通过 msg.value 获取，可根据该值计算对应的 WETH 数量，而后使用标准 ERC20 接口即可。</li>
</ul>
<h4 id="FeeOnTransferTokens"><a href="#FeeOnTransferTokens" class="headerlink" title="FeeOnTransferTokens"></a>FeeOnTransferTokens</h4><p>由于某些代币会在转账（transfer）过程中收取手续费，转账数量与实际收到的数量有差异，因此无法直接通过计算得出中间兑换过程中所需的代币数量，此时应该通过balanceOf方法（而非transfer方法）判断实际收到的代币数量。Router02新增了对Inclusive Fee On Transfer Tokens的支持，更具体说明可以参考<a target="_blank" rel="noopener" href="https://docs.uniswap.org/protocol/V2/reference/smart-contracts/common-errors#inclusive-fee-on-transfer-tokens">官方文档</a>。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://q1ngying.cn">Q1ngying</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://q1ngying.cn/UniswapV2/">https://q1ngying.cn/UniswapV2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://q1ngying.cn" target="_blank">Q1ngying</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Solidity/">Solidity</a><a class="post-meta__tags" href="/tags/DeFi/">DeFi</a></div><div class="post-share"><div class="social-share" data-image="/img/butterfly-icon.jpg" data-sites="twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="prev-post pull-left" href="/EIP721-ERC721_NFT/" title="EIP721：ERC721非同质化代币标准"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">EIP721：ERC721非同质化代币标准</div></div></a><a class="next-post pull-right" href="/EIP601-ERC601_EthereumHierarchyForDeterministicWallets/" title="EIP601"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">EIP601</div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a href="/FlashSwap/" title="UniswapV2-Flash Swap"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-09</div><div class="title">UniswapV2-Flash Swap</div></div></a><a href="/UniswapV2-Factory/" title="UniswapV2-Factory"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-09</div><div class="title">UniswapV2-Factory</div></div></a><a href="/UniswapV2-Pair/" title="UniswapV2-Pair"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-09</div><div class="title">UniswapV2-Pair</div></div></a><a href="/UniswapV2-Router/" title="UniswapV2-Router"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-09</div><div class="title">UniswapV2-Router</div></div></a><a href="/UniswapV2Intro/" title="UniswapV2入门"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-09</div><div class="title">UniswapV2入门</div></div></a><a href="/UniswapV2-Library/" title="UniswapV2-Library"><div class="cover" style="background: var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-09</div><div class="title">UniswapV2-Library</div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Uniswap-v2-%E5%90%88%E7%BA%A6%E4%BB%A3%E7%A0%81"><span class="toc-number">1.</span> <span class="toc-text">深入理解 Uniswap v2 合约代码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%88%E7%BA%A6%E6%9E%B6%E6%9E%84%EF%BC%9A"><span class="toc-number">1.1.</span> <span class="toc-text">合约架构：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Uniswap-v2-core"><span class="toc-number">1.2.</span> <span class="toc-text">Uniswap-v2-core</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#UniswapV2Factory"><span class="toc-number">1.2.1.</span> <span class="toc-text">UniswapV2Factory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UniswapV2ERC20"><span class="toc-number">1.2.2.</span> <span class="toc-text">UniswapV2ERC20</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UniswapV2Pair"><span class="toc-number">1.2.3.</span> <span class="toc-text">UniswapV2Pair</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mint-%E5%AE%9E%E7%8E%B0%E6%B7%BB%E5%8A%A0%E6%B5%81%E5%8A%A8%E6%80%A7%E5%8A%9F%E8%83%BD"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">mint-实现添加流动性功能</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#mintFee%E7%94%A8%E4%BA%8E%E8%AE%A1%E7%AE%97%E5%8D%8F%E8%AE%AE%E6%89%8B%E7%BB%AD%E8%B4%B9%EF%BC%9A"><span class="toc-number">1.2.3.1.1.</span> <span class="toc-text">_mintFee用于计算协议手续费：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#burn-%E5%AE%9E%E7%8E%B0%E7%A7%BB%E9%99%A4%E6%B5%81%E5%8A%A8%E6%80%A7%E5%8A%9F%E8%83%BD"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">burn-实现移除流动性功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#swap-%E5%AE%9E%E7%8E%B0%E4%B8%A4%E7%A7%8D%E4%BB%A3%E5%B8%81%E7%9A%84%E4%BA%A4%E6%8D%A2%EF%BC%88%E4%BA%A4%E6%98%93%EF%BC%89%E5%8A%9F%E8%83%BD"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">swap-实现两种代币的交换（交易）功能</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#update%E6%9B%B4%E6%96%B0%E7%BC%93%E5%AD%98%E4%BD%99%E9%A2%9D"><span class="toc-number">1.2.3.3.1.</span> <span class="toc-text">_update更新缓存余额</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#UniswapV2Router02"><span class="toc-number">1.3.</span> <span class="toc-text">UniswapV2Router02</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Library"><span class="toc-number">1.3.1.</span> <span class="toc-text">Library</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pairFor-%E8%AE%A1%E7%AE%97%E4%B8%A4%E4%B8%AA%E4%BB%A3%E5%B8%81%E7%9A%84%E4%BA%A4%E6%98%93%E5%AF%B9%E5%9C%B0%E5%9D%80"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">pairFor-计算两个代币的交易对地址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#quote-%E4%B8%A4%E4%B8%AA%E4%BB%A3%E5%B8%81%E4%B9%8B%E9%97%B4%E8%AE%A1%E4%BB%B7%E5%8D%95%E4%BD%8D%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">quote-两个代币之间计价单位转换</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getAmountOut"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">getAmountOut</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getAmountIn"><span class="toc-number">1.3.1.4.</span> <span class="toc-text">getAmountIn</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getAmountsOut"><span class="toc-number">1.3.1.5.</span> <span class="toc-text">getAmountsOut</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#getAmountsIn"><span class="toc-number">1.3.1.6.</span> <span class="toc-text">getAmountsIn</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ERC20-ERC20"><span class="toc-number">1.3.2.</span> <span class="toc-text">ERC20-ERC20</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#addLiquidity-%E6%B7%BB%E5%8A%A0%E6%B5%81%E5%8A%A8%E6%80%A7"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">addLiquidity 添加流动性</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#addLiquidity%E8%AE%A1%E7%AE%97%E6%9C%80%E4%BD%B3%E6%B1%87%E7%8E%87"><span class="toc-number">1.3.2.1.1.</span> <span class="toc-text">_addLiquidity计算最佳汇率</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#removeLiquidity-%E7%A7%BB%E5%87%BA%E6%B5%81%E5%8A%A8%E6%80%A7"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">removeLiquidity 移出流动性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#removeLiquidityWithPermit-%E4%BD%BF%E7%94%A8%E7%AD%BE%E5%90%8D%E7%A7%BB%E9%99%A4%E6%B5%81%E5%8A%A8%E6%80%A7"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">removeLiquidityWithPermit 使用签名移除流动性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#swapExactTokensForTokens-%E6%A0%B9%E6%8D%AE%E6%8C%87%E5%AE%9A%E7%9A%84%E8%BE%93%E5%85%A5%E4%BB%A3%E5%B8%81%EF%BC%8C%E8%8E%B7%E5%BE%97%E6%9C%80%E5%A4%9A%E7%9A%84%E8%BE%93%E5%87%BA%E4%BB%A3%E5%B8%81"><span class="toc-number">1.3.2.4.</span> <span class="toc-text">swapExactTokensForTokens-根据指定的输入代币，获得最多的输出代币</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#swap"><span class="toc-number">1.3.2.4.1.</span> <span class="toc-text">_swap</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#swapTokensForExactTokens-%E6%A0%B9%E6%8D%AE%E6%8C%87%E5%AE%9A%E7%9A%84%E8%BE%93%E5%85%A5%E4%BB%A3%E5%B8%81%E4%BD%BF%E7%94%A8%E6%9C%80%E5%B0%91%E7%9A%84%E8%BE%93%E5%85%A5%E4%BB%A3%E5%B8%81%E5%AE%8C%E6%88%90%E5%85%91%E6%8D%A2"><span class="toc-number">1.3.2.5.</span> <span class="toc-text">swapTokensForExactTokens-根据指定的输入代币使用最少的输入代币完成兑换</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ERC20-ETH"><span class="toc-number">1.3.3.</span> <span class="toc-text">ERC20_ETH</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ETH-Support"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">ETH Support</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#FeeOnTransferTokens"><span class="toc-number">1.3.3.2.</span> <span class="toc-text">FeeOnTransferTokens</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url(/img/back1.webp);"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2024 By Q1ngying</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script>(() => {
  const panguFn = () => {
    if (typeof pangu === 'object') pangu.autoSpacingPage()
    else {
      btf.getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
        .then(() => {
          pangu.autoSpacingPage()
        })
    }
  }

  const panguInit = () => {
    if (false){
      GLOBAL_CONFIG_SITE.isPost && panguFn()
    } else {
      panguFn()
    }
  }

  btf.addGlobalFn('pjaxComplete', panguInit, 'pangu')
  document.addEventListener('DOMContentLoaded', panguInit)
})()</script><div class="js-pjax"></div><script id="canvas_nest" defer="defer" color="17,185,200" opacity="0.8" zIndex="-1" count="200" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script></div></body></html>